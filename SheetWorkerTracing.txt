// <!-- Stat Mod Calculation -->
function StatMod(stat)// Takes Stat total, returns bonus (base bonus).
  
// <!-- Stat Calculation -->
function StatCalc(base, racial, special)// Takes base stat, racial bonus, special bonus, returns total bonus.
  
// <!-- Generic Skill - Rank Bonus Calculation -->
function GenSkillMod(rank, prog0, prog10, prog20, prog30, prog31) // takes skill rank and progression and returns rank bonus
  
// <!-- Body Dev Progression Setup -->
function BodyDevProgMod(racialindex, pindex, currentval)// takes racial index (my value) and progression index and returns current rank modifier.  Passes through the current value if the race is set to "custom" rather than one of the premades
  
// <!-- Set Realm -->
function SetRealm(rselect, intmod, empmod, premod)// takes realm selection, in mod, em mod, and pr mod and returns proper realm bonus depending upon selected realm and current stats.
  
// <!-- Power Point Dev Progression Setup -->
function PPDevProgMod(rselect, racialindex, pindex, currentval)// takes realm selection, racial index (my value), and progression index and returns current rank modifier.  Passes through the current value if the race is set to "custom" rather than one of the premades
  
// <!-- Race Fixed Info (Stat, RR bonuses + Soul Departure/Recovery Multiplier) Setup -->
function RaceFixedInfoSetup(racialindex, index, currentval)// takes racial index and a value index for which stat/resistance/etc and returns the value for that race.  Passes through the current value if race is set to a non-supported/custom race.
  
// <!-- Profession Bonus for Skill Categories Setup -->
function ProfessionInfoSetup(professionindex, index, currentval)// takes a profession index and an index for which skill category and returns Profession bonus for that skill/profession combo.
  
//	<!---- Calc skill bonus from ranks/progression (use GenSkillMod to calc the actual value) ---->	
function SkillChange(name)// takes skill name. <getAttrs/setAttrs> Sets skill bonus (calls GenSkillMod to calc that bonus)

//		Update the dropdown stats for the skills since they got renamed and we don't want to lose data NYI
function FixDropdownStats(name)// takes the statname from the dropdown and figures out whati's real name and value are, then sets them. <getAttrs/setAttrs> (best I can tell this one works; think i forgot to remove the NYI)
 
//	<!---- Calc total skill bonus ------->	
function CalcTotalBonus(name)//takes skill name.  Calculates and sets total skill bonus.  <getAttrs/setAttrs>  **this one potentially fires a lot**

// <!-- change the skill stat when the skill dropdown changes -->
function DropdownStatChange(statname)// takes stat name.  changes to new stat value when dropdown is changed.  <getAttrs/setAttrs>  *This one has some GiGs updates already though a todo listed still*

// <!---- Copy Offensive Bonus from skill to attack if you can find it ---->
function WeaponOBCopy(attack)// takes attack slot.  If weapon copy is set, tries to find corresponding skill and copy it to attack Offensive bonus field.  <big getAttrs/setAttrs at end w/ switch statement inbetween>

// <!---- Set up Attack type and Roll type ---->
function AttackTypeSetup(attack)// takes attack slot.  fills out attack calculation, attack roll, and type fields for building the attack macros. <getAttrs/setAttrs at end w/ switch inbetween>

// <!---- Set up breakage number calculations for the attack macro ---->
function BreakageMacroSetup(attack)// takes attack slot.  sets up breakage check for attack macros if breakage numbers are entered.  <getAttrs (probably read more than needed)/setAttrs at end of switch>

//  <!-- if the Breakage number for an Attack changes, change the breakage macro calculation -->
on ('sheet:opened',  // setup the events to watch for the breakage numbers of an attack to change; if they do, run the BreakageMacroSetup function.

//  <!-- if the type for an Attack changes, change the attack calculation -->
on ('sheet:opened', // set up events to watch for an attack type to change.  if they do, run AttackTypeSetup function.

//  <!-- if the name for an Attack changes, check if you can find an OB/skill to copy in for it -->
on ('sheet:opened', // set up events to watch for an attack (name) to change.  If one does, run WeaponOBCopy function to try and copy the ob over.

//  <!-- Update copied OB if the weapon/attack skill changes.  Have to check them all since don't know if/where the attack might be  -->
on ('change:<all handled attack skills> change:copyob', // if any of the handled attack skills change, getAttrs to see if we are allowed to copy the OB over, if are, then run WeaponOBCopy on all the attacks to see if that skill is in one of them/copy the ob over.  ** I have a feeling there could be a better way to do this, but what it is?? **

// <!---- Copy Armor from Primary/Secondary/Tertiary to Worn ---->
on('change:activearmor', // If one of the armor-set checkboxes is clicked, copy over the information from that column to the worn (active) column.  <getAttrs/setAttrs>  fixed this; Gigs approved new code.

// <!-- Recalc skills -->
on('change:skillrecalc', // it clears the checkbox.  a different function actually does the work.  <getAttrs/setAttrs>

// <!-- Update stats for skills with stat dropdowns -->
on ('sheet:opened', // setup change events for skill which have custom skill options and stat changes to update the skills if either the skill or the stat changes.  Also do it when the skill recalc button is clicked.  runs DropDownStatChange for the actual change.

// <!-- Stat calculation/update for Categories (stat1+stat2) and skills (stat) -->
on('change:agbonus change:variablestatbonuscalc change:skillrecalc', // when the total agility bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.
		//Agility-based Categories
		
// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:cobonus change:variablestatbonuscalc change:skillrecalc', // when the total constitution bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.			//Constitution-based Categories

// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:embonus change:variablestatbonuscalc change:skillrecalc', // when the total empathy bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.			
//Empathy-based Categories
   
// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:inbonus change:variablestatbonuscalc change:skillrecalc', // when the total intuition bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.			//Intuition-based Categories

// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:mebonus change:variablestatbonuscalc change:skillrecalc', // when the total memory bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.			//Memory-based Categories

// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:prbonus change:variablestatbonuscalc change:skillrecalc', // when the total presence bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.			//Presence-based Categories

// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:qubonus change:variablestatbonuscalc change:skillrecalc', // when the total quickness bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.			//Quickness-based Categories

// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:rebonus change:variablestatbonuscalc change:skillrecalc', // when the total reasoning bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.			//Reasoning-based Categories

// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:sdbonus change:variablestatbonuscalc change:skillrecalc', // when the total self discipline bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.
			//Self Discipline-based Categories
			
// <!-- Stat calculation for Categories (stat1+stat2) -->
on('change:stbonus change:variablestatbonuscalc change:skillrecalc', // when the total strength bonus changes or the sheet is switched between skill/category 3rd stat or the recalc button is tripped, get al the relavant attributes and write out the appropriate stat bonus values.  Both categories and skills.  <getAttrs/setAttrs>  needs some rewriting to fix the parseInt stuff.			//Strength-based Categories

// <!-- if powerpoint development total changes, update powerpoints-->
on('change:ppdev change:ppmult', // if power point development or power point multiplier values change, recalculate the power points.  <getAttrs/setAttrs>

// <!-- if realm (bonus) changes, update things-->
on('change:realm change:skillrecalc', // if the realm is changed or the recalc button clicked, the realm stat value needs to be propagated through powerpoint development and the various spell casting skills. <getAttrs/setAttrs>
 
// when a category changes, the total category bonus needs to be copied down to each of the skills in the category.  <getAttrs/setAttrs>
// <!-- Copy over Armor-Heavy Category Bonus-->
on('change:cat-armor-heavy', 
// <!-- Copy over Armor-Light Category Bonus-->
on('change:cat-armor-light', 
// <!-- Copy over Armor-Medium Category Bonus-->
on('change:cat-armor-med', 
// <!-- Copy over Artistic-Active Category Bonus-->
on('change:cat-artistic-active', 
// <!-- Copy over Artistic-Passive Category Bonus-->
on('change:cat-artistic-passive',
// <!-- Copy over Athletic-Brawn Category Bonus-->
on('change:cat-athletic-brawn', 
// <!-- Copy over Athletic-Endurance Category Bonus-->
on('change:cat-athletic-endur',
// <!-- Copy over Athletic-Gymnastics Category Bonus-->
on('change:cat-athletic-gym',
// <!-- Copy over Awareness-Perception Category Bonus-->
on('change:cat-aware-percept', 
// <!-- Copy over Awareness-Searching Category Bonus-->
on('change:cat-aware-search',
// <!-- Copy over Awareness-Senses Category Bonus-->
on('change:cat-aware-senses',
// <!-- Copy over Combat-Maneuvers Category Bonus-->
on('change:cat-combat-maneuvers',  
// <!-- Copy over Communications Category Bonus-->
on('change:cat-communications',
// <!-- Copy over Crafts Category Bonus-->
on('change:cat-crafts',
// <!-- Copy over Directed Spells Category Bonus-->
on('change:cat-directed-spells',
// <!-- Copy over Influence Category Bonus-->
on('change:cat-influence',
// <!-- Copy over Lore-General Category Bonus-->
on('change:cat-lore-general',
// <!-- Copy over Lore-Magical Category Bonus-->
on('change:cat-lore-magical',
// <!-- Copy over Lore-Obscure Category Bonus-->
on('change:cat-lore-obscure',
// <!-- Copy over Lore-Technical Category Bonus-->
on('change:cat-lore-technical',
// <!-- Copy over Martial Arts-Striking Category Bonus-->
on('change:cat-ma-striking',
// <!-- Copy over Martial Arts-Sweeps Category Bonus-->
on('change:cat-ma-sweeps',
// <!-- Copy over Outdoor-Animal Category Bonus-->
on('change:cat-outdoor-animal',
// <!-- Copy over Outdoor-Environmental Category Bonus-->
on('change:cat-outdoor-environ', 
// <!-- Copy over Power Awareness Category Bonus-->
on('change:cat-power-awareness',
// <!-- Copy over Power Manipulation Category Bonus-->
on('change:cat-power-manipulation', 
// <!-- Copy over Science-Basic Category Bonus-->
on('change:cat-science-basic', 
// <!-- Copy over Science-Specialized Category Bonus-->
on('change:cat-science-specialized', 
// <!-- Copy over Self-Control Category Bonus-->
on('change:cat-self-control', 
// <!-- Copy over Special-Attacks Category Bonus-->
on('change:cat-special-attacks', 
// <!-- Copy over Special-Defenses Category Bonus-->
on('change:cat-special-defenses', 
// <!-- Copy over Subterfuge-Attack Category Bonus-->
on('change:cat-subterfuge-attack', 
// <!-- Copy over Subterfuge-Mechanics Category Bonus-->
on('change:cat-subterfuge-mechanics', 
// <!-- Copy over Subterfuge-Stealth Category Bonus-->
on('change:cat-subterfuge-stealth', 
// <!-- Copy over Technical/Trade-General Category Bonus-->
on('change:cat-tech-general', 
// <!-- Copy over Technical/Trade-Professional Category Bonus-->
on('change:cat-tech-professional', 
// <!-- Copy over Technical/Trade-Vocational Category Bonus-->
on('change:cat-tech-vocational', 
// <!-- Copy over Urban Category Bonus-->
on('change:cat-urban', 
// <!-- Copy over Weapon-1-H Concussion Category Bonus-->
on('change:cat-weapon-1hconcussion', 
// <!-- Copy over Weapon-1-H Edged Category Bonus-->
on('change:cat-weapon-1hedged', 
// <!-- Copy over Weapon-2-Handed Category Bonus-->
on('change:cat-weapon-2handed', 
// <!-- Copy over Weapon-Missile Category Bonus-->
on('change:cat-weapon-missile', 
// <!-- Copy over Weapon-Missile Artillery Category Bonus-->
on('change:cat-weapon-missileartillery', 
// <!-- Copy over Weapon-Pole Arms Category Bonus-->
on('change:cat-weapon-polearms', 
// <!-- Copy over Weapon-Thrown Category Bonus-->
on('change:cat-weapon-thrown', 
// <!-- Copy over Same Realm Own Base Spells Category Bonus-->
on('change:cat-srob', 
// <!-- Copy over Same Realm Open Spells Category Bonus-->
on('change:cat-sropen', 
// <!-- Copy over Same Realm Closed Spells Category Bonus-->
on('change:cat-srclosed', 
// <!-- Copy over Same Realm Other Base Spells Category Bonus-->
on('change:cat-srotherb', 
// <!-- Copy over Other Realm Open Spells Category Bonus-->
on('change:cat-oropen', 
// <!-- Copy over Other Realm Closed Spells Category Bonus-->
on('change:cat-orclosed', 
// <!-- Copy over Other Realm Base Spells Category Bonus-->
on('change:cat-orbase',   
// <!-- Copy over Arcane Open Spells Category Bonus-->
on('change:cat-arcopen', 
// <!-- Copy over Arcane Closed Spells Category Bonus-->
on('change:cat-arcclosed', 
// <!-- Copy over Arcane Base Spells Category Bonus-->
on('change:cat-arcbase', 
// <!-- Copy over Arcane Other Base Spells Category Bonus-->
on('change:cat-arcotherbase', 

//	<!---- Update bonus on current stat change.  Do this for each stat ---->	
// Calculate Base Bonus
on('change:agility change:statcalc', // if agility (Ag Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
// Calculate total bonus 
on('sheet:opened change:agbasebonus change:agracial change:agspecial', // if the base stat bonus (Agility in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:constitution change:statcalc',  // if constitution (Co Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:cobasebonus change:coracial change:cospecial',  // if the base stat bonus (Constitution in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:memory change:statcalc', // if memory (Me Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:mebasebonus change:meracial change:mespecial',  // if the base stat bonus (Memory in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:reasoning change:statcalc',  // if reasoning (Re Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:rebasebonus change:reracial change:respecial', // if the base stat bonus (Reasoning in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:selfdiscipline change:statcalc', // if self discipline (SD Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:sdbasebonus change:sdracial change:sdspecial', // if the base stat bonus (Self Discipline in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:empathy change:statcalc', // if empathy (Em Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:embasebonus change:emracial change:emspecial', // if the base stat bonus (Empathy in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:intuition change:statcalc', // if intuition (In Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:inbasebonus change:inracial change:inspecial',  // if the base stat bonus (Intuition in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:presence change:statcalc', // if presence (Pr Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:prbasebonus change:prracial change:prspecial',  // if the base stat bonus (Presence in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:quickness change:statcalc', // if quickness (Qu Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:qubasebonus change:quracial change:quspecial',  // if the base stat bonus (Quickness in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>

on('change:strength change:statcalc', // if strength (St Temp) or the statcalc setup changes, then use StatMod to figure out what the base stat bonus should be.  <getAttrs/setAttrs>
on('sheet:opened change:stbasebonus change:stracial change:stspecial', // if the base stat bonus (Strength in this case) or the racial or special bonuses for the stat change, then recalculate the total stat bonus. <getAttrs/setAttrs>
  
// Calculate developement points from top 5 stats (ag, co, me, re, sd) if any change.  But only if devpointcalc is set.
on('change:devpointcalc change:agility change:constitution change:memory change:reasoning change:selfdiscipline', // <getAttrs/setAttrs> 
  
//  <!---- Calc experience for next level if level or levelexpcalc changes ------->
on('change:levelexpcalc change:level', // if a character's level changes or if xp calculation automation is added/removed, calculate what the next level will be and what the experience needed for it will be.  <getAttrs/setAttrs>
  
//	<!---- Update Body Dev progression,Racial bonuses for RR's and Stats etc when racialindex changes.---->	
on('change:racialindex change:racialcalc', // if the race changes or the race calculation automation is toggled, use BodyDevProgMod, and RaceFixedInfoSetup, to set up body development progression, racial stat bonuses, racial resistance bonuses, and things like soul departure, recovery multiplier, etc.  Does not yet set up skill bonuses for races.  (probably should but how to do the nebulous things ie +to heat/cold resistance, etc?).  <getAttrs/setAttrs>
  
//  <!---- Then update Bodydev rank bonus ............ even if rank has not changed ----->
on('change:bodydevprog0 change:bodydevprog10 change:bodydevprog20 change:bodydevprog30 change:bodydevprog31 change:racialcalc change:skillcalc', // if the body dev progression changes or skill calc or racial calc is toggled, then recalculate the body developement rank bonus.  Since it likely changed.  <getAttrs/setAttrs> 
  
//	<!---- Update professionindex (skill category) bonuses when professionindex changes---->	
on('change:professionindex change:professioncalc', // if the profession changes or the profession calc is toggled, use ProfessionInfoSetup to setup the profession category bonuses. <getAttrs/setAttrs>

//	<!---- update realm stat when realm or realm stat changes---->	
on('change:realmselect change:inbonus change:embonus change:prbonus ', // if the realm is changed or any one of the realm stats changes, use SetRealm to setup the realm stat.  <getAttrs/setAttrs>

//	<!---- update ppdev progression when realm or racialindex change---->	
on('change:realmselect change:racialindex change:racialcalc', // if the realm or race changes or the racial calc is toggled, use PPDevProgMod to setup the powerpoint progression for that race/realm combo.  <getAttrs/setAttrs>
  
//  <!---- Then update PPdev rank bonus ........... even if rank has not changed ----->
on('change:realm change:ppdevranks change:ppdevprog0 change:ppdevprog10 change:ppdevprog20 change:ppdevprog30 change:ppdevprog31 change:skillcalc change:racialcalc change:inbonus change:embonus change:prbonus', // if realm, power point development ranks, progression, or realmstats change, or if the skill calc or racial calc setups are toggled, then calculate powerpoint development.  <getAttrs/setAttrs> 
  
//	<!---- Do this for each skill to set up OnChange events ---->	
on('sheet:opened', // for every non-repeating skill, skill category, and spell list, setup functions to watch for skill rank change and use SkillChange to calculate the rank bonus, and watch for changes in the skill rankbonus, stat, category bonus, special modifier, item modifier, profession bonus, stat bonus, special bonus, and itembonus and use CalcTotalBonus to calculate the new total bonus for the skill.  

//<!---- Calc rank bonus for repeating skills ---->
on('change:repeating_skills', // if something in the repeating skills section changes, use SkillChange to calculate the skill rank bonus.

//<!---- Calc rank bonus for repeating languages ---->
on('change:repeating_langs', // if something in repeating languages changes, calculate the skill rank bonus.  Have to call it for both spoken and written because they have different names.

//  <!---- If repeating_langs_* changes, make a nice summary for the front page for me ---->
on('change:repeating_langs change:embonus change:mebonus change:rebonus change:cat-communications remove:repeating_langs', // when the communication category (rank bonus, profession bonus, special bonus, or item bonus), reasoning bonus, memory bonus, or empathy bonus change, then calculate the written and spoken language bonuses and create a summary of them for the front page.  <getAttrs/setAttrs>  Gigs has looked at/optimized this one. 

// <!---- Calculate total experience ---->
on('change:repeating_exp remove:repeating_exp' // if a change is made in the repeating experience tab, recalculate the experience total.  <getAttrs/setAttrs> Not part of a long cascade.

//  <!---- Copy experience from totalexperience to expcurrent on PC/Char tab if wanted ---->
on('change:totalexperience change:xpcopy', // if totalexperience changes or the xp copy button is toggled, copy the xp to the front page if set for that.  <getAttrs/setAttrs> don't need to open expcurrent and expcurrent_max....  Not part of a long cascade.

//  <!---- Calculate total coin count and weight for each column ----> //gigs done
on('change:coinsperpound change:mithril1 change:platinum1 change:gold1 change:silver1 change:bronze1 change:copper1 change:tin1 change:iron1 change:mithril2 change:platinum2 change:gold2 change:silver2 change:bronze2 change:copper2 change:tin2 change:iron2 change:mithril3 change:platinum3 change:gold3 change:silver3 change:bronze3 change:copper3 change:tin3 change:iron3 change:coinlocationcat1 change:coinlocationcat2 change:coinlocationcat3', // <getAttrs/setAttrs>  but ^^  Not part of a long cascade.

// <!----Calculates the total weight/row and total weight for each weight category. ---->
on('change:repeating_equipment:equipmentquantity change:repeating_equipment:equipmentweight change:repeating_equipment:equipmentlocationtype', // equipment is a repeating set. <getAttrs/setAttrs> Not part of a long cascade.

on('change:repeating_equipment:equipmentweighttotal change:repeating_equipment:equipmentlocationtype remove:repeating_equipment change:coinweight1 change:coinweight2 change:coinweight3 change:coinlocationcat1 change:coinlocationcat2 change:coinlocationcat3', // if weights change, then update the total weights for each location.  <getAttrs/setAttrs>  Gigs looked at this one too.  Not part of a long cascade.

//  <!---- Copy from equipment weights to totalweightcarried if wanted ---->
on('change:weightcarried change:weightcarriedcopy change:weightbackpack change:weightbackpackcopy change:weightstored1 change:weightstored2 change:weightstored1copy change:weightstored2copy', // use the checkboxes next to the total weights for each location to determine which are included in the encumbrance calculation. <getAttrs/setAttrs> Not part of a long cascade.

/* <!----- Close other skill categories when one is open to help with lag -----> */
const categories = ['armor', 'artistic', 'athletic', 'awareness', 'bodydev', 'combatman', 'communications', 'crafts', 'dirspells', 'influence',
    'lore', 'martialarts', 'outdoor', 'power', 'powerpointdev', 'science', 'selfcontrol', 'special', 'spellsskills', 'subterfuge', 'technical',
    'urban', 'weapon', 'other']; // <getAttrs/setAttrs>  Gigs wrote this one.  Not part of a cascade.

/* Setup for when a character sheet gets opened for the first time.  -Calc ability and ability mods as well as encumbrance. */
function StartingSetup(version, cversion, calc, langsmoved) {
    let mod = version;
    console.log('/* ----------entering StartingSetup; sheetversion:' + version + '  cversion:' + cversion + '  calc:' + calc + '------------ */' + langsmoved);
    if (version < cversion) {mod = cversion;}
    if ((version < 4.00) || (isNaN(version))) {
        mod = cversion;
        if (version < 4.00) {
            getAttrs(['level'], function(values) {
                setAttrs({ 'npclevel': values.level }); 	// fix npclevel to be the same as level if this is the first time run
            });
        }
        if ((isNaN(version)) || (calc == 0)) {
            //				copy repeating_skills_skillranksbonus to repeating_skills_skillrankbonus to fix typo so that the calc function works on these.
            getSectionIDs('repeating_skills', function(idarray){
                if (idarray.length>0) {
                    _.each(idarray, function(currentID) {
                        getAttrs(['repeating_skills_'+currentID+'_skillranksbonus', 'repeating_skills_'+currentID+'_skillrankbonus'], function(values) {
                            var update = {};
                            update['repeating_skills_'+currentID+'_skillrankbonus'] = parseInt(values['repeating_skills_'+currentID+'_skillranksbonus'],10);
                            setAttrs(update);
                        });
                    });
                }				
            });
        }
    }
    if ((version < 4.00) || (isNaN(version))) {
        mod = cversion;
        getAttrs(['dbvsspellworn', 'dbvsspell1', 'dbvsspell2'], function(values) {
            let defnoteupdate= '(RR/DB) vs Evil Spell Casters:  Worn:' + values.dbvsspellworn + '; 1:' + values.dbvsspell1 + '; 2:' + values.dbvsspell2;
            setAttrs({ 'conditionaldefensesnotes': defnoteupdate }); //removed vs Evil Spell casters; here is its new home.
        });
    }
    if ((version < 4.09) || (isNaN(version))) {	
        mod = cversion;
        //fixed syntax for spell lists so they match skills; a couple things need to be moved to the new syntax:
        getAttrs(['srob-catprofbonus', 'srob-catspecialbonus', 'sropen-catprofbonus', 'sropen-catspecialbonus', 'srclosed-catprofbonus', 'srclosed-catspecialbonus', 'srotherb-catprofbonus', 'srotherb-catspecialbonus', 'oropen-catprofbonus', 'oropen-catspecialbonus', 'orclosed-catprofbonus', 'orclosed-catspecialbonus', 'orbase-catprofbonus', 'orbase-catspecialbonus', 'arcopen-catprofbonus', 'arcopen-catspecialbonus', 'arcclosed-catprofbonus', 'arcclosed-catspecialbonus', 'arcbase-catprofbonus', 'arcbase-catspecialbonus', 'arcotherbase-catprofbonus', 'arcotherbase-catspecialbonus'], function(values) {
            setAttrs({ 
                'cat-srobprofbonus': parseInt(values['srob-catprofbonus'],10)||0,
                'cat-srobspecialbonus': parseInt(values['srob-catspecialbonus'],10)||0,
                'cat-sropenprofbonus': parseInt(values['sropen-catprofbonus'],10)||0,
                'cat-sropenspecialbonus': parseInt(values['sropen-catspecialbonus'],10)||0,
                'cat-srclosedprofbonus': parseInt(values['srclosed-catprofbonus'],10)||0,
                'cat-srclosedspecialbonus': parseInt(values['srclosed-catspecialbonus'],10)||0,
                'cat-srotherbprofbonus': parseInt(values['srotherb-catprofbonus'],10)||0,
                'cat-srotherbspecialbonus': parseInt(values['srotherb-catspecialbonus'],10)||0,
                'cat-oropenprofbonus': parseInt(values['oropen-catprofbonus'],10)||0,
                'cat-oropenspecialbonus': parseInt(values['oropen-catspecialbonus'],10)||0,
                'cat-orclosedprofbonus': parseInt(values['orclosed-catprofbonus'],10)||0,
                'cat-orclosedspecialbonus': parseInt(values['orclosed-catspecialbonus'],10)||0,
                'cat-orbaseprofbonus': parseInt(values['orbase-catprofbonus'],10)||0,
                'cat-orbasespecialbonus': parseInt(values['orbase-catspecialbonus'],10)||0,
                'cat-arcopenprofbonus': parseInt(values['arcopen-catprofbonus'],10)||0,
                'cat-arcopenspecialbonus': parseInt(values['arcopen-catspecialbonus'],10)||0,
                'cat-arcclosedprofbonus': parseInt(values['arcclosed-catprofbonus'],10)||0,
                'cat-arcclosedspecialbonus': parseInt(values['arcclosed-catspecialbonus'],10)||0,
                'cat-arcbaseprofbonus': parseInt(values['arcbase-catprofbonus'],10)||0,
                'cat-arcbasespecialbonus': parseInt(values['arcbase-catspecialbonus'],10)||0,
                'cat-arcotherbaseprofbonus': parseInt(values['arcotherbase-catprofbonus'],10)||0,
                'cat-arcotherbasespecialbonus': parseInt(values['arcotherbase-catspecialbonus'],10)||0
            }); 
        });
        // recalc skill totals (copy stats and categories, etc since this is just put in with sheetworkers instead of disabled totals
        setAttrs({
            skillrecalc:0
        });
        // new setup for the dropdown stats for the customizable skills.  Copy over the old data.  NYI
        /*		FixDropdownStats('awaresenses1');
      FixDropdownStats('awaresenses2');
      FixDropdownStats('awaresenses3');
      FixDropdownStats('combatmaneuvers1');
      FixDropdownStats('combatmaneuvers2');
      FixDropdownStats('combatmaneuvers3');*/
        //		FixDropdownStats("craft15");
        /*		FixDropdownStats('craft16');
      FixDropdownStats('boltattack6');
      FixDropdownStats('loregeneral1');
      FixDropdownStats('loregeneral2');
      FixDropdownStats('loregeneral3');
      FixDropdownStats('outdooranimal1');
      FixDropdownStats('outdooranimal2');
      FixDropdownStats('outdooranimal3');
      FixDropdownStats('specscience1');
      FixDropdownStats('specscience2');
      FixDropdownStats('subtermech1');
      FixDropdownStats('subtermech2');
      FixDropdownStats('techprof1');
      FixDropdownStats('techprof2');
      FixDropdownStats('techprof3');
      FixDropdownStats('techvoc1');
      FixDropdownStats('techvoc2');*/
    }	
    if ((version < 4.11) || (isNaN(version))) {	
        mod = cversion;
        //	fix weaponxtype to weaponxselect.  should cascade through rest of setup:  
        console.log('/*------------- entering fix weapontype to weaponselect ------------*/');
        getAttrs(['attack1type', 'attack2type', 'attack3type', 'attack4type', 'attack5type', 'attack6type', 'attack7type', 'attack8type', 'npcattack1type', 'npcattack2type', 'npcattack3type', 'npcattack4type', 'npcattack5type', 'npcattack6type', 'npcattack7type', 'npcattack8type', 'attack1select', 'attack2select', 'attack3select', 'attack4select', 'attack5select', 'attack6select', 'attack7select', 'attack8select', 'npcattack1select', 'npcattack2select', 'npcattack3select', 'npcattack4select', 'npcattack5select', 'npcattack6select', 'npcattack7select', 'npcattack8select'], function(values) {
            let update = {};
            console.log('/*---------- attack1type:'+values.attack1type+';-- npcattack1type:'+values.npcattack1type+'----*/');
            if (values.attack1type == '[[1d100!>96cf<@{attack1fumble}+@{attack1bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]]]') { update['attack1select'] = 'melee'; }
            else if (values.attack1type == '[[1d100!>96cf<@{attack1fumble}+@{attack1bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action] ]]') { update['attack1select'] = 'ranged'; }
            else if (values.attack1type == '[[1d100cf<2cs>96+@{attack1bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}]]') { update['attack1select'] = 'basic'; }
            else if (values.attack1type == '[[1d100!>96cf<2cs=100+@{attack1bonus}[Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { update['attack1select'] = 'directed'; }
            else if (values.attack1type == '[[1d100cf<4cs>96+@{attack1bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center] ]]') { update['attack1select'] = 'area'; }
            else if (values.attack1type == 'no type') { update['attack1select'] = 'none'; }
            else { update['attack1select'] = 'none';}
            if (values.attack2type == '[[1d100!>96cf<@{attack2fumble}+@{attack2bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]]]') { update['attack2select'] = 'melee'; }
            else if (values.attack2type == '[[1d100!>96cf<@{attack2fumble}+@{attack2bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action] ]]') { update['attack2select'] = 'ranged'; }
            else if (values.attack2type == '[[1d100cf<2cs>96+@{attack2bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}]]') { update['attack2select'] = 'basic'; }
            else if (values.attack2type == '[[1d100!>96cf<2cs=100+@{attack2bonus}[Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { update['attack2select'] = 'directed'; }
            else if (values.attack2type == '[[1d100cf<4cs>96+@{attack2bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center] ]]') { update['attack2select'] = 'area'; }
            else if (values.attack2type == 'no type') { update['attack2select'] = 'none'; }
            else { update['attack2select'] = 'none';}
            if (values.attack3type == '[[1d100!>96cf<@{attack3fumble}+@{attack3bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]]]') { update['attack3select'] = 'melee'; }
            else if (values.attack3type == '[[1d100!>96cf<@{attack3fumble}+@{attack3bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action] ]]') { update['attack3select'] = 'ranged'; }
            else if (values.attack3type == '[[1d100cf<2cs>96+@{attack3bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}]]') { update['attack3select'] = 'basic'; }
            else if (values.attack3type == '[[1d100!>96cf<2cs=100+@{attack3bonus}[Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { update['attack3select'] = 'directed'; }
            else if (values.attack3type == '[[1d100cf<4cs>96+@{attack3bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center] ]]') { update['attack3select'] = 'area'; }
            else if (values.attack3type == 'no type') { update['attack3select'] = 'none'; }
            else { update['attack3select'] = 'none';}
            if (values.attack4type == '[[1d100!>96cf<@{attack4fumble}+@{attack4bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]]]') { update['attack4select'] = 'melee'; }
            else if (values.attack4type == '[[1d100!>96cf<@{attack4fumble}+@{attack4bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action] ]]') { update['attack4select'] = 'ranged'; }
            else if (values.attack4type == '[[1d100cf<2cs>96+@{attack4bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}]]') { update['attack4select'] = 'basic'; }
            else if (values.attack4type == '[[1d100!>96cf<2cs=100+@{attack4bonus}[Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { update['attack4select'] = 'directed'; }
            else if (values.attack4type == '[[1d100cf<4cs>96+@{attack4bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center] ]]') { update['attack4select'] = 'area'; }
            else if (values.attack4type == 'no type') { update['attack4select'] = 'none'; }
            else { update['attack4select'] = 'none';}
            if (values.attack5type == '[[1d100!>96cf<@{attack5fumble}+@{attack5bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]]]') { update['attack5select'] = 'melee'; }
            else if (values.attack5type == '[[1d100!>96cf<@{attack5fumble}+@{attack5bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action] ]]') { update['attack5select'] = 'ranged'; }
            else if (values.attack5type == '[[1d100cf<2cs>96+@{attack5bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}]]') { update['attack5select'] = 'basic'; }
            else if (values.attack5type == '[[1d100!>96cf<2cs=100+@{attack5bonus}[Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { update['attack5select'] = 'directed'; }
            else if (values.attack5type == '[[1d100cf<4cs>96+@{attack5bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center] ]]') { update['attack5select'] = 'area'; }
            else if (values.attack5type == 'no type') { update['attack5select'] = 'none'; }
            else { update['attack5select'] = 'none';}
            if (values.attack6type == '[[1d100!>96cf<@{attack6fumble}+@{attack6bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]]]') { update['attack6select'] = 'melee'; }
            else if (values.attack6type == '[[1d100!>96cf<@{attack6fumble}+@{attack6bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action] ]]') { update['attack6select'] = 'ranged'; }
            else if (values.attack6type == '[[1d100cf<2cs>96+@{attack6bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}]]') { update['attack6select'] = 'basic'; }
            else if (values.attack6type == '[[1d100!>96cf<2cs=100+@{attack6bonus}[Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { update['attack6select'] = 'directed'; }
            else if (values.attack6type == '[[1d100cf<4cs>96+@{attack6bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center] ]]') { update['attack6select'] = 'area'; }
            else if (values.attack6type == 'no type') { update['attack6select'] = 'none'; }
            else { update['attack6select'] = 'none';}
            if (values.attack7type == '[[1d100!>96cf<@{attack7fumble}+@{attack7bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]]]') { update['attack7select'] = 'melee'; }
            else if (values.attack7type == '[[1d100!>96cf<@{attack7fumble}+@{attack7bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action] ]]') { update['attack7select'] = 'ranged'; }
            else if (values.attack7type == '[[1d100cf<2cs>96+@{attack7bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}]]') { update['attack7select'] = 'basic'; }
            else if (values.attack7type == '[[1d100!>96cf<2cs=100+@{attack7bonus}[Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { update['attack7select'] = 'directed'; }
            else if (values.attack7type == '[[1d100cf<4cs>96+@{attack7bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center] ]]') { update['attack7select'] = 'area'; }
            else if (values.attack7type == 'no type') { update['attack7select'] = 'none'; }
            else { update['attack7select'] = 'none';}
            if (values.attack8type == '[[1d100!>96cf<@{attack8fumble}+@{attack8bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]]]') { update['attack8select'] = 'melee'; }
            else if (values.attack8type == '[[1d100!>96cf<@{attack8fumble}+@{attack8bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action] ]]') { update['attack8select'] = 'ranged'; }
            else if (values.attack8type == '[[1d100cf<2cs>96+@{attack8bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}]]') { update['attack8select'] = 'basic'; }
            else if (values.attack8type == '[[1d100!>96cf<2cs=100+@{attack8bonus}[Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { update['attack8select'] = 'directed'; }
            else if (values.attack8type == '[[1d100cf<4cs>96+@{attack8bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center] ]]') { update['attack8select'] = 'area'; }
            else if (values.attack8type == 'no type') { update['attack8select'] = 'none'; }
            else { update['attack8select'] = 'none';}
            if (values.npcattack1type == '[[1d100!>96cf<@{npcattack1fumble}+@{npcattack1bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})-@{target|dbworn}[target db] ]]') { 
                update['npcattack1select'] = 'npcmelee'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack1rolltype'] = '1d100!>96cf<@{npcattack1fumble}';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100!>96cf<@{npcattack1fumble} +@{npcattack1bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack1select'] = 'npcmelee'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack1rolltype'] = '1d100!>96cf<@{npcattack1fumble}';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100!>96cf<@{npcattack1fumble}+@{npcattack1bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]+?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60})-@{target|dbworn}[target db] ]]') { 
                update['npcattack1select'] = 'npcranged'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack1rolltype'] = '1d100!>96cf<@{npcattack1fumble}';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack1select'] = 'npcranged'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack1rolltype'] = '1d100!>96cf<@{npcattack1fumble}';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100!>96cf<@{npcattack1fumble} +@{npcattack1bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack1select'] = 'npcranged'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack1rolltype'] = '1d100!>96cf<@{npcattack1fumble}';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100cf<2cs>96+@{npcattack1bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] ]]') { 
                update['npcattack1select'] = 'npcbasic'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack1rolltype'] = '1d100cf<2cs>96';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100cf<2cs>96+@{npcattack1bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { 
                update['npcattack1select'] = 'npcbasic'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack1rolltype'] = '1d100cf<2cs>96';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100!>96cf<2cs=100+@{npcattack1bonus}[OB]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]-@{target|dbworn}[target db] ]]') { 
                update['npcattack1select'] = 'npcdirected'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack1rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100!>96cf<2cs=100+@{npcattack1bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack1select'] = 'npcdirected'; 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack1rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100cf<4cs>96+@{npcattack1bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]-@{target|dbworn}[target db] + .5*@{target|dbarmdbworn}[adjustment for only 1/2 armor bonus to db] ]]') { 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack1rolltype'] = '1d100cf<4cs>96';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == '[[1d100cf<4cs>96+@{npcattack1bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus] ]]') { 
                update['npcattack1attackcalc'] = '@{npcattack1bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack1rolltype'] = '1d100cf<4cs>96';
                update['npcattack1type'] = '[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
            }
            else if (values.npcattack1type == 'no type') { update['npcattack1select'] = 'none'; }
            else { update['npcattack1select'] = 'none';}
            if (values.npcattack2type == '[[1d100!>96cf<@{npcattack2fumble}+@{npcattack2bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})-@{target|dbworn}[target db] ]]') { 
                update['npcattack2select'] = 'npcmelee'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack2rolltype'] = '1d100!>96cf<@{npcattack2fumble}';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack2select'] = 'npcmelee'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack2rolltype'] = '1d100!>96cf<@{npcattack2fumble}';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100!>96cf<@{npcattack2fumble}+@{npcattack2bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]+?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60})-@{target|dbworn}[target db] ]]') { 
                update['npcattack2select'] = 'npcranged'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack2rolltype'] = '1d100!>96cf<@{npcattack2fumble}';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack2select'] = 'npcranged'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack2rolltype'] = '1d100!>96cf<@{npcattack2fumble}';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack2select'] = 'npcranged'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack2rolltype'] = '1d100!>96cf<@{npcattack2fumble}';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100cf<2cs>96+@{npcattack2bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] ]]') { 
                update['npcattack2select'] = 'npcbasic'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack2rolltype'] = '1d100cf<2cs>96';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100cf<2cs>96+@{npcattack2bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { 
                update['npcattack2select'] = 'npcbasic'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack2rolltype'] = '1d100cf<2cs>96';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100!>96cf<2cs=100+@{npcattack2bonus}[OB]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]-@{target|dbworn}[target db] ]]') { 
                update['npcattack2select'] = 'npcdirected'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack2rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100!>96cf<2cs=100+@{npcattack2bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack2select'] = 'npcdirected'; 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack2rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100cf<4cs>96+@{npcattack2bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]-@{target|dbworn}[target db] + .5*@{target|dbarmdbworn}[adjustment for only 1/2 armor bonus to db] ]]') { 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack2rolltype'] = '1d100cf<4cs>96';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == '[[1d100cf<4cs>96+@{npcattack2bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus] ]]') { 
                update['npcattack2attackcalc'] = '@{npcattack2bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack2rolltype'] = '1d100cf<4cs>96';
                update['npcattack2type'] = '[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
            }
            else if (values.npcattack2type == 'no type') { update['npcattack2select'] = 'none'; }
            else { update['npcattack2select'] = 'none';}
            if (values.npcattack3type == '[[1d100!>96cf<@{npcattack3fumble}+@{npcattack3bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})-@{target|dbworn}[target db] ]]') { 
                update['npcattack3select'] = 'npcmelee'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack3rolltype'] = '1d100!>96cf<@{npcattack3fumble}';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100!>96cf<@{npcattack3fumble} +@{npcattack3bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack3select'] = 'npcmelee'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack3rolltype'] = '1d100!>96cf<@{npcattack3fumble}';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100!>96cf<@{npcattack3fumble}+@{npcattack3bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]+?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60})-@{target|dbworn}[target db] ]]') { 
                update['npcattack3select'] = 'npcranged'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack3rolltype'] = '1d100!>96cf<@{npcattack3fumble}';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack3select'] = 'npcranged'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack3rolltype'] = '1d100!>96cf<@{npcattack3fumble}';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100!>96cf<@{npcattack3fumble} +@{npcattack3bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack3select'] = 'npcranged'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack3rolltype'] = '1d100!>96cf<@{npcattack3fumble}';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100cf<2cs>96+@{npcattack3bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] ]]') { 
                update['npcattack3select'] = 'npcbasic'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack3rolltype'] = '1d100cf<2cs>96';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100cf<2cs>96+@{npcattack3bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { 
                update['npcattack3select'] = 'npcbasic'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack3rolltype'] = '1d100cf<2cs>96';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100!>96cf<2cs=100+@{npcattack3bonus}[OB]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]-@{target|dbworn}[target db] ]]') { 
                update['npcattack3select'] = 'npcdirected'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack3rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100!>96cf<2cs=100+@{npcattack3bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack3select'] = 'npcdirected'; 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack3rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100cf<4cs>96+@{npcattack3bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]-@{target|dbworn}[target db] + .5*@{target|dbarmdbworn}[adjustment for only 1/2 armor bonus to db] ]]') { 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack3rolltype'] = '1d100cf<4cs>96';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == '[[1d100cf<4cs>96+@{npcattack3bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus] ]]') { 
                update['npcattack3attackcalc'] = '@{npcattack3bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack3rolltype'] = '1d100cf<4cs>96';
                update['npcattack3type'] = '[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
            }
            else if (values.npcattack3type == 'no type') { update['npcattack3select'] = 'none'; }
            else { update['npcattack3select'] = 'none';}
            if (values.npcattack4type == '[[1d100!>96cf<@{npcattack4fumble}+@{npcattack4bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})-@{target|dbworn}[target db] ]]') { 
                update['npcattack4select'] = 'npcmelee'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack4rolltype'] = '1d100!>96cf<@{npcattack4fumble}';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100!>96cf<@{npcattack4fumble} +@{npcattack4bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack4select'] = 'npcmelee'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack4rolltype'] = '1d100!>96cf<@{npcattack4fumble}';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100!>96cf<@{npcattack4fumble}+@{npcattack4bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]+?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60})-@{target|dbworn}[target db] ]]') { 
                update['npcattack4select'] = 'npcranged'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack4rolltype'] = '1d100!>96cf<@{npcattack4fumble}';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack4select'] = 'npcranged'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack4rolltype'] = '1d100!>96cf<@{npcattack4fumble}';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100!>96cf<@{npcattack4fumble} +@{npcattack4bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack4select'] = 'npcranged'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack4rolltype'] = '1d100!>96cf<@{npcattack4fumble}';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100cf<2cs>96+@{npcattack4bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] ]]') { 
                update['npcattack4select'] = 'npcbasic'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack4rolltype'] = '1d100cf<2cs>96';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100cf<2cs>96+@{npcattack4bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { 
                update['npcattack4select'] = 'npcbasic'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack4rolltype'] = '1d100cf<2cs>96';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100!>96cf<2cs=100+@{npcattack4bonus}[OB]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]-@{target|dbworn}[target db] ]]') { 
                update['npcattack4select'] = 'npcdirected'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack4rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100!>96cf<2cs=100+@{npcattack4bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack4select'] = 'npcdirected'; 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack4rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100cf<4cs>96+@{npcattack4bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]-@{target|dbworn}[target db] + .5*@{target|dbarmdbworn}[adjustment for only 1/2 armor bonus to db] ]]') { 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack4rolltype'] = '1d100cf<4cs>96';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == '[[1d100cf<4cs>96+@{npcattack4bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus] ]]') { 
                update['npcattack4attackcalc'] = '@{npcattack4bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack4rolltype'] = '1d100cf<4cs>96';
                update['npcattack4type'] = '[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
            }
            else if (values.npcattack4type == 'no type') { update['npcattack4select'] = 'none'; }
            else { update['npcattack4select'] = 'none';}
            if (values.npcattack5type == '[[1d100!>96cf<@{npcattack5fumble}+@{npcattack5bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})-@{target|dbworn}[target db] ]]') { 
                update['npcattack5select'] = 'npcmelee'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack5rolltype'] = '1d100!>96cf<@{npcattack5fumble}';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100!>96cf<@{npcattack5fumble} +@{npcattack5bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack5select'] = 'npcmelee'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack5rolltype'] = '1d100!>96cf<@{npcattack5fumble}';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100!>96cf<@{npcattack5fumble}+@{npcattack5bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]+?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60})-@{target|dbworn}[target db] ]]') { 
                update['npcattack5select'] = 'npcranged'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack5rolltype'] = '1d100!>96cf<@{npcattack5fumble}';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack5select'] = 'npcranged'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack5rolltype'] = '1d100!>96cf<@{npcattack5fumble}';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100!>96cf<@{npcattack5fumble} +@{npcattack5bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack5select'] = 'npcranged'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack5rolltype'] = '1d100!>96cf<@{npcattack5fumble}';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100cf<2cs>96+@{npcattack5bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] ]]') { 
                update['npcattack5select'] = 'npcbasic'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack5rolltype'] = '1d100cf<2cs>96';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100cf<2cs>96+@{npcattack5bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { 
                update['npcattack5select'] = 'npcbasic'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack5rolltype'] = '1d100cf<2cs>96';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100!>96cf<2cs=100+@{npcattack5bonus}[OB]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]-@{target|dbworn}[target db] ]]') { 
                update['npcattack5select'] = 'npcdirected'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack5rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100!>96cf<2cs=100+@{npcattack5bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack5select'] = 'npcdirected'; 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack5rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100cf<4cs>96+@{npcattack5bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]-@{target|dbworn}[target db] + .5*@{target|dbarmdbworn}[adjustment for only 1/2 armor bonus to db] ]]') { 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack5rolltype'] = '1d100cf<4cs>96';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == '[[1d100cf<4cs>96+@{npcattack5bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus] ]]') { 
                update['npcattack5attackcalc'] = '@{npcattack5bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack5rolltype'] = '1d100cf<4cs>96';
                update['npcattack5type'] = '[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
            }
            else if (values.npcattack5type == 'no type') { update['npcattack5select'] = 'none'; }
            else { update['npcattack5select'] = 'none';}
            if (values.npcattack6type == '[[1d100!>96cf<@{npcattack6fumble}+@{npcattack6bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})-@{target|dbworn}[target db] ]]') { 
                update['npcattack6select'] = 'npcmelee'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack6rolltype'] = '1d100!>96cf<@{npcattack6fumble}';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100!>96cf<@{npcattack6fumble} +@{npcattack6bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack6select'] = 'npcmelee'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack6rolltype'] = '1d100!>96cf<@{npcattack6fumble}';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100!>96cf<@{npcattack6fumble}+@{npcattack6bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]+?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60})-@{target|dbworn}[target db] ]]') { 
                update['npcattack6select'] = 'npcranged'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack6rolltype'] = '1d100!>96cf<@{npcattack6fumble}';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack6select'] = 'npcranged'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack6rolltype'] = '1d100!>96cf<@{npcattack6fumble}';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100!>96cf<@{npcattack6fumble} +@{npcattack6bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack6select'] = 'npcranged'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack6rolltype'] = '1d100!>96cf<@{npcattack6fumble}';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100cf<2cs>96+@{npcattack6bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] ]]') { 
                update['npcattack6select'] = 'npcbasic'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack6rolltype'] = '1d100cf<2cs>96';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100cf<2cs>96+@{npcattack6bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { 
                update['npcattack6select'] = 'npcbasic'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack6rolltype'] = '1d100cf<2cs>96';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100!>96cf<2cs=100+@{npcattack6bonus}[OB]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]-@{target|dbworn}[target db] ]]') { 
                update['npcattack6select'] = 'npcdirected'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack6rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100!>96cf<2cs=100+@{npcattack6bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack6select'] = 'npcdirected'; 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack6rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100cf<4cs>96+@{npcattack6bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]-@{target|dbworn}[target db] + .5*@{target|dbarmdbworn}[adjustment for only 1/2 armor bonus to db] ]]') { 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack6rolltype'] = '1d100cf<4cs>96';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == '[[1d100cf<4cs>96+@{npcattack6bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus] ]]') { 
                update['npcattack6attackcalc'] = '@{npcattack6bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack6rolltype'] = '1d100cf<4cs>96';
                update['npcattack6type'] = '[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
            }
            else if (values.npcattack6type == 'no type') { update['npcattack6select'] = 'none'; }
            else { update['npcattack6select'] = 'none';}
            if (values.npcattack7type == '[[1d100!>96cf<@{npcattack7fumble}+@{npcattack7bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})-@{target|dbworn}[target db] ]]') { 
                update['npcattack7select'] = 'npcmelee'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack7rolltype'] = '1d100!>96cf<@{npcattack7fumble}';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100!>96cf<@{npcattack7fumble} +@{npcattack7bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack7select'] = 'npcmelee'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack7rolltype'] = '1d100!>96cf<@{npcattack7fumble}';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100!>96cf<@{npcattack7fumble}+@{npcattack7bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]+?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60})-@{target|dbworn}[target db] ]]') { 
                update['npcattack7select'] = 'npcranged'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack7rolltype'] = '1d100!>96cf<@{npcattack7fumble}';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack7select'] = 'npcranged'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack7rolltype'] = '1d100!>96cf<@{npcattack7fumble}';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100!>96cf<@{npcattack7fumble} +@{npcattack7bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack7select'] = 'npcranged'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack7rolltype'] = '1d100!>96cf<@{npcattack7fumble}';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100cf<2cs>96+@{npcattack7bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] ]]') { 
                update['npcattack7select'] = 'npcbasic'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack7rolltype'] = '1d100cf<2cs>96';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100cf<2cs>96+@{npcattack7bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { 
                update['npcattack7select'] = 'npcbasic'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack7rolltype'] = '1d100cf<2cs>96';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100!>96cf<2cs=100+@{npcattack7bonus}[OB]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]-@{target|dbworn}[target db] ]]') { 
                update['npcattack7select'] = 'npcdirected'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack7rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100!>96cf<2cs=100+@{npcattack7bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack7select'] = 'npcdirected'; 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack7rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100cf<4cs>96+@{npcattack7bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]-@{target|dbworn}[target db] + .5*@{target|dbarmdbworn}[adjustment for only 1/2 armor bonus to db] ]]') { 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack7rolltype'] = '1d100cf<4cs>96';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == '[[1d100cf<4cs>96+@{npcattack7bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus] ]]') { 
                update['npcattack7attackcalc'] = '@{npcattack7bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack7rolltype'] = '1d100cf<4cs>96';
                update['npcattack7type'] = '[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
            }
            else if (values.npcattack7type == 'no type') { update['npcattack7select'] = 'none'; }
            else { update['npcattack7select'] = 'none';}
            if (values.npcattack8type == '[[1d100!>96cf<@{npcattack8fumble}+@{npcattack8bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]-(100-?{% Activity used on attack|100})-@{target|dbworn}[target db] ]]') { 
                update['npcattack8select'] = 'npcmelee'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack8rolltype'] = '1d100!>96cf<@{npcattack8fumble}';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100!>96cf<@{npcattack8fumble} +@{npcattack8bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack8select'] = 'npcmelee'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] -(100-?{% Activity used on attack|100}) -[[@{target|dbworn}]][target db]';
                update['npcattack8rolltype'] = '1d100!>96cf<@{npcattack8fumble}';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100!>96cf<@{npcattack8fumble}+@{npcattack8bonus}[OB]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust)|0}[Parry]+?{Range Modification|0}[Range]+?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60})-@{target|dbworn}[target db] ]]') { 
                update['npcattack8select'] = 'npcranged'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack8rolltype'] = '1d100!>96cf<@{npcattack8fumble}';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100!>96cf<@{npcattack2fumble} +@{npcattack2bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbworn}]][target db] ]]') { 
                update['npcattack8select'] = 'npcranged'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack8rolltype'] = '1d100!>96cf<@{npcattack8fumble}';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100!>96cf<@{npcattack8fumble} +@{npcattack8bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack8select'] = 'npcranged'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[OB] +?{Position Bonus?|0}[Position] +?{Status Bonus/Penalty?|0}[Status] +?{Parry(db adjust)|0}[Parry] +?{Range Modification|0}[Range] +?{Missile Attack Penalty(-5 for AT6; -10 for AT10/14/18; -15 for AT7/8; -20 for AT11/15/16; -30 for AT12/19; -40 for AT20)|0}-(60-?{% Activity used on missile attack|60}) -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack8rolltype'] = '1d100!>96cf<@{npcattack8fumble}';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100cf<2cs>96+@{npcattack8bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] ]]') { 
                update['npcattack8select'] = 'npcbasic'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack8rolltype'] = '1d100cf<2cs>96';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100cf<2cs>96+@{npcattack8bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range] ]]') { 
                update['npcattack8select'] = 'npcbasic'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                update['npcattack8rolltype'] = '1d100cf<2cs>96';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100!>96cf<2cs=100+@{npcattack8bonus}[OB]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]-@{target|dbworn}[target db] ]]') { 
                update['npcattack8select'] = 'npcdirected'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack8rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100!>96cf<2cs=100+@{npcattack8bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db] ]]') { 
                update['npcattack8select'] = 'npcdirected'; 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[OB] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] -[[@{target|dbwornranged}]][target ranged db]';
                update['npcattack8rolltype'] = '1d100!>@{oeuproll}cf<2cs=100';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100cf<4cs>96+@{npcattack8bonus}[List Ranks]+?{Special Item Bonus?|0}[Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]-@{target|dbworn}[target db] + .5*@{target|dbarmdbworn}[adjustment for only 1/2 armor bonus to db] ]]') { 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack8rolltype'] = '1d100cf<4cs>96';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == '[[1d100cf<4cs>96+@{npcattack8bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus] ]]') { 
                update['npcattack8attackcalc'] = '@{npcattack8bonus}[List Ranks] +?{Special Item Bonus?|0}[Item] +?{Status Bonus/Penalty?|0}[Status] +?{Range Modification|0}[Range] +20*?{Center point of spell?(1=yes)|0}[Spell Center] -[[((@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})) + abs(@{target|dbquickbonworn} -abs(@{target|dbquickpenworn})))/2]][target quickness bonus] - [[.5*(@{target|dbarmdbworn})]][1/2 armor bonus to db] -[[@{target|dbmagicbonworn}]][magical(item) db bonus]'; 
                update['npcattack8rolltype'] = '1d100cf<4cs>96';
                update['npcattack8type'] = '[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
            }
            else if (values.npcattack8type == 'no type') { update['npcattack8select'] = 'none'; }
            else { update['npcattack8select'] = 'none';}
            setAttrs(update); 
            //	Also set weapon breakage stuff.            
            BreakageMacroSetup('attack1');
            BreakageMacroSetup('attack2');
            BreakageMacroSetup('attack3');
            BreakageMacroSetup('attack4');
            BreakageMacroSetup('attack5');
            BreakageMacroSetup('attack6');
            BreakageMacroSetup('attack7');
            BreakageMacroSetup('attack8');
            BreakageMacroSetup('npcattack1');
            BreakageMacroSetup('npcattack2');
            BreakageMacroSetup('npcattack3');
            BreakageMacroSetup('npcattack4');
            BreakageMacroSetup('npcattack5');
            BreakageMacroSetup('npcattack6');
            BreakageMacroSetup('npcattack7');
            BreakageMacroSetup('npcattack8');
        });
    }	
    if ((langsmoved == 0) || (isNaN(langsmoved))) {       //if the languages have already been moved; don't do it again!
        //  Copy/create languages   Move this outside of calc == 0......
        getSectionIDs('repeating_languages', function(idarray){
            if (idarray.length>0) {
                console.log('Language ID array length: '+idarray.length);
                _.each(idarray, function(currentID) {
                    getAttrs(['repeating_languages_'+currentID+'_languagename', 'repeating_languages_'+currentID+'_languagespoken-rank', 'repeating_languages_'+currentID+'_languagespoken-skill', 'repeating_languages_'+currentID+'_languagewritten-rank', 'repeating_languages_'+currentID+'_languagewritten-skill', 'repeating_languages2_'+currentID+'_language2name', 'repeating_languages2_'+currentID+'_language2spoken-rank', 'repeating_languages2_'+currentID+'_language2spoken-skill', 'repeating_languages2_'+currentID+'_language2written-rank', 'repeating_languages2_'+currentID+'_language2written-skill'], function(values) {
                        var update = {};
                        var newID = generateRowID();
                        if (values['repeating_languages_'+currentID+'_languagename']){						//   Check for languagename
                            update['repeating_langs_'+newID+'_languagename'] = values['repeating_languages_'+currentID+'_languagename'];
                        } else {			                												//   Else set the name to 'Trade' in case folks didn't change from what was diplayed.
                            //	console.log("Not a lang1");
                            update['repeating_langs_'+newID+'_languagename'] = 'Trade';
                        }
                        if (values['repeating_languages_'+currentID+'_languagespoken-rank']){				//   Check for languagespoken-rank
                            update['repeating_langs_'+newID+'_languagespokenranks'] = values['repeating_languages_'+currentID+'_languagespoken-rank'];
                        } else {																			//   Else set it to the default 4 in case folks didn't change from what was diplayed.
                            update['repeating_langs_'+newID+'_languagespokenranks'] = 4;
                        }
                        if (values['repeating_languages_'+currentID+'_languagewritten-rank']){				//   Check for languagewritten-rank
                            update['repeating_langs_'+newID+'_languagewrittenranks'] = values['repeating_languages_'+currentID+'_languagewritten-rank'];
                        } else {																			//   Else set it to the default 4 in case folks didn't change from what was diplayed.
                            update['repeating_langs_'+newID+'_languagewrittenranks'] = 4;
                        }
                        //		if the sheet does not do the calc for you, then copy the skills as well.
                        if (calc == 0) {
                            if (values['repeating_languages_'+currentID+'_languagespoken-skill']){			//   Check for languagespoken-skill
                                update['repeating_langs_'+newID+'_languagespokenrankbonus'] = values['repeating_languages_'+currentID+'_languagespoken-skill'];
                            } else {																		//   Else set it to the default 45 in case folks didn't change from what was diplayed.
                                update['repeating_langs_'+newID+'_languagespokenrankbonus'] = 45;
                            }							
                            if (values['repeating_languages_'+currentID+'_languagewritten-skill']){			//   Check for languagewritten-skill
                                update['repeating_langs_'+newID+'_languagewrittenrankbonus'] = values['repeating_languages_'+currentID+'_languagewritten-skill'];
                            } else {																		//   Else set it to the default 45 in case folks didn't change from what was diplayed.
                                update['repeating_langs_'+newID+'_languagewrittenrankbonus'] = 45;
                            }
                        }
                        setAttrs(update);
                    });
                });
            }
        });
      
        getSectionIDs('repeating_languages2', function(idarray2){
            if (idarray2.length>0) {
                console.log('Language2 ID array length: '+idarray2.length);
                _.each(idarray2, function(currentID2) {
                    getAttrs(['repeating_languages_'+currentID2+'_languagename', 'repeating_languages_'+currentID2+'_languagespoken-rank', 'repeating_languages_'+currentID2+'_languagespoken-skill', 'repeating_languages_'+currentID2+'_languagewritten-rank', 'repeating_languages_'+currentID2+'_languagewritten-skill', 'repeating_languages2_'+currentID2+'_language2name', 'repeating_languages2_'+currentID2+'_language2spoken-rank', 'repeating_languages2_'+currentID2+'_language2spoken-skill', 'repeating_languages2_'+currentID2+'_language2written-rank', 'repeating_languages2_'+currentID2+'_language2written-skill'], function(values) {
                        var update = {};
                        var newID2 = generateRowID();
                        if (values['repeating_languages2_'+currentID2+'_language2name']){  			//   If there is no languagename, then try language2name
                            //	console.log("Not a lang1");
                            update['repeating_langs_'+newID2+'_languagename'] = values['repeating_languages2_'+currentID2+'_language2name'];
                        } else {			                												//   Else set the name to 'Trade' in case folks didn't change from what was diplayed.
                            //	console.log("Not a lang1");
                            update['repeating_langs_'+newID2+'_languagename'] = 'Trade';
                        }
                        if (values['repeating_languages2_'+currentID2+'_language2spoken-rank']){		//   If there is no languagespoken-rank, then try language2spoken-rank
                            update['repeating_langs_'+newID2+'_languagespokenranks'] = values['repeating_languages2_'+currentID2+'_language2spoken-rank'];
                        } else {																			//   Else set it to the default 4 in case folks didn't change from what was diplayed.
                            update['repeating_langs_'+newID2+'_languagespokenranks'] = 4;
                        }
                        if (values['repeating_languages2_'+currentID2+'_language2written-rank']){		// 	  If there is no languagewritten-rank, then try language2written-rank
                            update['repeating_langs_'+newID2+'_languagewrittenranks'] = values['repeating_languages2_'+currentID2+'_language2written-rank'];
                        } else {																			//   Else set it to the default 4 in case folks didn't change from what was diplayed.
                            update['repeating_langs_'+newID2+'_languagewrittenranks'] = 4;
                        }
                        //		if the sheet does not do the calc for you, then copy the skills as well.
                        if (calc == 0) {
                            if (values['repeating_languages_'+currentID2+'_language2spoken-skill']){	//   If there is no languagespoken-skill, then try language2spoken-skill
                                update['repeating_langs_'+newID2+'_languagespokenrankbonus'] = values['repeating_languages2_'+currentID2+'_language2spoken-skill'];
                            } else {																		//   Else set it to the default 45 in case folks didn't change from what was diplayed.
                                update['repeating_langs_'+newID2+'_languagespokenrankbonus'] = 45;
                            }							
                            if (values['repeating_languages_'+currentID2+'_language2written-skill']){	//   If there is no languagewritten-skill, then try language2written-skill
                                update['repeating_langs_'+newID2+'_languagewrittenrankbonus'] = values['repeating_languages2_'+currentID2+'_language2written-skill'];
                            } else {																		//   Else set it to the default 45 in case folks didn't change from what was diplayed.
                                update['repeating_langs_'+newID2+'_languagewrittenrankbonus'] = 45;
                            }
                        }
                        setAttrs(update);
                    });
                });
            }
        });
      
        setAttrs({
            languagesmoved: 1	// set the languages as moved
        });
    }

    console.log('/* ----------leaving StartingSetup; mod:' + mod + '------------ */');
    setAttrs({
        character_sheet: 'RMSS-FullCalcs v3.'+mod
    });
    return mod;
}
//gigs todo
// <!---- Setup Racial Index for autocalculations ---->
on('sheet:opened change:race', function() {
    getAttrs(['race', 'racialindex'], function(values) {
        //   console.log('/* ----------Racial Index Setup; race:' + (values.race.toLowerCase()) + '------------ */');
        let rindex; //gigs todo
        if ((values.race.toLowerCase()) === 'common man') { rindex = 10; }
        else if ((values.race.toLowerCase()) === 'common orc') { rindex = 51; }
        else if ((values.race.toLowerCase()) === 'dwarf') { rindex = 30; }
        else if ((values.race.toLowerCase()) === 'grey elf') { rindex = 22; }
        else if ((values.race.toLowerCase()) === 'greater orc') { rindex = 52; }
        else if ((values.race.toLowerCase()) === 'half-elf') { rindex = 20; }
        else if ((values.race.toLowerCase()) === 'half-orc') { rindex = 50; }
        else if ((values.race.toLowerCase()) === 'halfling') { rindex = 40; }
        else if ((values.race.toLowerCase()) === 'high elf') { rindex = 23; }
        else if ((values.race.toLowerCase()) === 'high man') { rindex = 12; }
        else if ((values.race.toLowerCase()) === 'mixed man') { rindex = 11; }
        else if ((values.race.toLowerCase()) === 'wood elf') { rindex = 21; }
        else if ((values.race.toLowerCase()) === 'none') { rindex = 99; }
        else { rindex = 1; }
        setAttrs({
            racialindex: rindex
        });
    });
});
// gigs todo
// <!---- Setup Profession Index for autocalculations ---->
on('sheet:opened change:profession', function() {
    getAttrs(['profession', 'professionindex'], function(values) {
        let profindex; // gigs todo
        if ((values.profession.toLowerCase()) === 'fighter') { profindex = 1; }
        else if ((values.profession.toLowerCase()) === 'thief') { profindex = 2; }
        else if ((values.profession.toLowerCase()) === 'rogue') { profindex = 3; }
        else if ((values.profession.toLowerCase()) === 'warrior monk') { profindex = 4; }
        else if ((values.profession.toLowerCase()) === 'layman') { profindex = 5; }
        else if ((values.profession.toLowerCase()) === 'magician') { profindex = 6; }
        else if ((values.profession.toLowerCase()) === 'illusionist') { profindex = 7; }
        else if ((values.profession.toLowerCase()) === 'cleric') { profindex = 8; }
        else if ((values.profession.toLowerCase()) === 'animist') { profindex = 9; }
        else if ((values.profession.toLowerCase()) === 'mentalist') { profindex = 10; }
        else if ((values.profession.toLowerCase()) === 'lay healer') { profindex = 11; }
        else if ((values.profession.toLowerCase()) === 'healer') { profindex = 12; }
        else if ((values.profession.toLowerCase()) === 'mystic') { profindex = 13; }
        else if ((values.profession.toLowerCase()) === 'sorcerer') { profindex = 14; }
        else if ((values.profession.toLowerCase()) === 'ranger') { profindex = 15; }
        else if ((values.profession.toLowerCase()) === 'paladin') { profindex = 16; }
        else if ((values.profession.toLowerCase()) === 'monk') { profindex = 17; }
        else if ((values.profession.toLowerCase()) === 'dabbler') { profindex = 18; }
        else if ((values.profession.toLowerCase()) === 'bard') { profindex = 19; }
        else if ((values.profession.toLowerCase()) === 'magent') { profindex = 20; }
        else if ((values.profession.toLowerCase()) === 'none') { profindex = 99; }
        else { profindex = 21; }
        setAttrs({
            professionindex: profindex
        });
    });
});


//  <!---- Run the setup if the sheet is opened or the recalc box is clicked ---->
on('sheet:opened change:skillcalc', function() {
    getAttrs(['sheetversion', 'currentsheetversion', 'skillcalc', 'languagesmoved'], function(values) {
        setAttrs({
            sheetversion: StartingSetup(parseFloat(values.sheetversion), parseFloat(values.currentsheetversion), parseInt(values.skillcalc,10), parseInt(values.languagesmoved,10))
        });
    });
});

// <!---- Change checkboxes for statcalc, skillcalc, levelexpcalc, racialcalc, and professioncalc if allcalc is changed. ---->
on('change:allcalc', function() {
    getAttrs(['allcalc', 'statcalc', 'levelexpcalc', 'skillcalc', 'racialcalc', 'professioncalc'], function(values) {
        if (parseInt(values.allcalc, 10) == 0) {
            setAttrs({
                statcalc: 0,
                devpointcalc: 0,
                levelexpcalc: 0,
                skillcalc: 0,
                racialcalc: 0,
                professioncalc: 0
            });
        } else if (parseInt(values.allcalc, 10) == 1) {
            setAttrs({
                statcalc: 1,
                devpointcalc: 1,
                levelexpcalc: 1,
                skillcalc: 1,
                racialcalc: 1,
                professioncalc: 1
            });
        }
    });
});

// <!---- If skillcalc gets changed, check and update the skills. ---->
on('change:skillcalc', function() {
    getAttrs(['skillcalc'], function(values) {
        //		console.log('/* ----------entering SkillCalc Change; skillcalc:' + values.skillcalc + '  allcalc:' + values.allcalc + '------------ */');
        if (parseInt(values.skillcalc, 10) == 1) {
            var skills=['srob-list1', 'srob-list2', 'srob-list3', 'srob-list4', 'srob-list5', 'srob-list6', 'srob-list7', 'srob-list8', 'srob-list9', 'srob-list10', 'sropen-list1', 'sropen-list2', 'sropen-list3', 'sropen-list4', 'sropen-list5', 'sropen-list6', 'sropen-list7', 'sropen-list8', 'sropen-list9', 'sropen-list10', 'srclosed-list1', 'srclosed-list2', 'srclosed-list3', 'srclosed-list4', 'srclosed-list5', 'srclosed-list6', 'srclosed-list7', 'srclosed-list8', 'srclosed-list9', 'srclosed-list10', 'srotherb-list1', 'srotherb-list2', 'srotherb-list3', 'srotherb-list4', 'srotherb-list5', 'srotherb-list6', 'oropen-list1', 'oropen-list2', 'oropen-list3', 'oropen-list4', 'oropen-list5', 'orclosed-list1', 'orclosed-list2', 'orclosed-list3', 'orclosed-list4', 'orclosed-list5', 'orbase-list1', 'orbase-list2', 'orbase-list3', 'orbase-list4', 'orbase-list5', 'arcopen-list1', 'arcopen-list2', 'arcopen-list3', 'arcopen-list4', 'arcopen-list5', 'arcclosed-list1', 'arcclosed-list2', 'arcclosed-list3', 'arcclosed-list4', 'arcclosed-list5', 'arcbase-list1', 'arcbase-list2', 'arcbase-list3', 'arcbase-list4', 'arcbase-list5', 'arcotherbase-list1', 'arcotherbase-list2', 'arcotherbase-list3', 'arcotherbase-list4', 'arcotherbase-list5', 'cat-armor-heavy-', 'plate', 'cat-armor-light-', 'softleather', 'rigidleather', 'cat-armor-med-', 'chain', 'cat-artistic-active-', 'acting', 'dancing', 'mimery', 'mimicry', 'playinstrument1', 'playinstrument2', 'playinstrument3', 'poeticimprov', 'singing', 'taletelling', 'ventriloquism', 'cat-artistic-passive-', 'music', 'painting', 'poetry', 'sculpting', 'cat-athletic-brawn-', 'athleticgamesbrawn1', 'athleticgamesbrawn2', 'athleticgamesbrawn3', 'jumping', 'powerstriking', 'powerthrowing', 'weightlifting', 'cat-athletic-endur-', 'athleticgamesendur1', 'athleticgamesendur2', 'athleticgamesendur3', 'distancerunning', 'rowing', 'scaling', 'sprinting', 'swimming', 'cat-athletic-gym-', 'acrobatics', 'athleticgamesgym1', 'athleticgamesgym2', 'athleticgamesgym3', 'climbing', 'contortions', 'diving', 'flyglide', 'juggling', 'polevaulting', 'rappelling', 'skating', 'skiing', 'stiltwalking', 'surfing', 'tightrope', 'tumbling', 'alertness', 'senseambush', 'cat-aware-search-', 'detecttraps', 'lieperception', 'locatehidden', 'observation', 'poisonperception', 'readtracks', 'surveillance', 'tracking', 'cat-aware-senses-', 'directionsense', 'realityawareness', 'senseawareness1', 'sitawareness1', 'sla', 'timesense', 'awaresenses1', 'awaresenses2', 'awaresenses3', 'bodydev', 'adrenaldeflecting', 'mountedcombat', 'quickdraw', 'reversestroke1', 'subdual', 'swashbuckling', 'tumbleevade', 'twoweaponfighting1', 'combatmaneuvers1', 'combatmaneuvers2', 'combatmaneuvers3', 'cat-communications-', 'lipreading', 'signaling', 'cooking', 'fletching', 'leathercrafts', 'metalcrafts', 'ropemastery', 'scribing', 'sewing', 'skinning', 'stonecrafts', 'trapping', 'woodcrafts', 'craft15', 'craft16', 'cat-directed-spells-', 'firebolt', 'icebolt', 'lightningbolt', 'shockbolt', 'waterbolt', 'boltattack6', 'cat-influence-', 'bribery', 'diplomacy', 'duping', 'interrogation', 'leadership', 'propaganda', 'publicspeaking', 'seduction', 'trading', 'cat-lore-general-', 'culturelore1', 'faunalore', 'floralore', 'heraldry', 'history', 'philosophy', 'regionlore1', 'religion', 'loregeneral1', 'loregeneral2', 'loregeneral3', 'cat-lore-magical-', 'artifactlore', 'circlelore', 'planarlore', 'spelllore', 'symbollore', 'undeadlore', 'wardinglore', 'cat-lore-obscure-', 'demondevillore', 'dragonlore', 'faerielore', 'xenolore1', 'xenolore2', 'xenolore3', 'cat-lore-technical-', 'herblore', 'locklore', 'metallore', 'poisonlore', 'stonelore', 'tradinglore', 'cat-ma-striking-', 'boxing', 'striking1', 'striking2', 'striking3', 'striking4', 'tackling', 'cat-ma-sweeps-', 'blocking', 'sweeps1', 'sweeps2', 'sweeps3', 'sweeps4', 'wrestling', 'cat-outdoor-animal-', 'animalhandling1', 'animalhealing1', 'animalmastery', 'animaltraining1', 'driving1', 'herding1', 'riding1', 'outdooranimal1', 'outdooranimal2', 'outdooranimal3', 'cat-outdoor-environ-', 'caving', 'foraging', 'hunting', 'stargazing', 'survival1', 'survival2', 'survival3', 'weatherwatching', 'cat-power-awareness-', 'attunement', 'divination1', 'divination2', 'divination3', 'powerperception', 'readrunes', 'channeling', 'magicritual', 'spellmastery1', 'spellmastery2', 'spellmastery3', 'transcendarmor', 'ppdev', 'cat-science-basic-', 'basicmath', 'research', 'advancedmath', 'anthropology1', 'alchemy', 'astronomy', 'biochemistry', 'psychology', 'specscience1', 'specscience2', 'cat-self-control-', 'adrenalbalance', 'adrenalconcentration', 'adrenallanding', 'adrenalleaping', 'adrenalquickdraw', 'adrenalspeed', 'adrenalstabilization', 'adrenalstrength', 'cleansingtrance', 'controllycanthropy', 'deathtrance', 'frenzy', 'healingtrance', 'meditation', 'mnemonics', 'sleeptrance', 'stunnedmaneuvering', 'brawling', 'disarmarmedvs1h', 'disarmarmedvs2h', 'disarmarmedvspolearm', 'disarmarmedvs2wcombo', 'disarmunarmedvs1hedged', 'disarmunarmedvs2h', 'disarmunarmedvspolearm', 'disarmunarmedvs1hconcussion', 'jousting', 'adrenaldefense', 'adrenaltoughness', 'cat-subterfuge-attack-', 'ambush', 'silentkill', 'cat-subterfuge-mechanics-', 'camouflage', 'disarmingtraps', 'disguise', 'counterfeiting', 'forgery1', 'hidingitems', 'picklocks', 'settraps', 'trapbuilding', 'usepoison', 'subtermech1', 'subtermech2', 'cat-subterfuge-stealth-', 'hiding', 'pickpockets', 'stalking', 'trickery', 'cat-tech-general-', 'begging', 'firstaid', 'gambling', 'mapping', 'operatingequipment', 'orienteering', 'sailing', 'tacticalgames', 'useprepherbs', 'advertising', 'architecture', 'diagnostics1', 'dowsing', 'engineering1', 'mechanition1', 'militaryorg1', 'mining1', 'secondaid', 'surgery', 'techprof1', 'techprof2', 'techprof3', 'administration', 'appraisal', 'boatpilot1', 'cartography', 'evalarmor', 'evalmetal', 'evalstone', 'evalweapon', 'gimmickry', 'hypnosis', 'midwifery', 'navigation', 'prepareherbs', 'preparepoisons', 'siegeengineering', 'tactics', 'techvoc1', 'techvoc2', 'cat-urban-', 'contacting', 'mingling', 'scrounging', 'streetwise', 'cat-weapon-1hconcussion-', 'weapon1hc1', 'weapon1hc2', 'weapon1hc3', 'cat-weapon-1hedged-', 'weapon1he1', 'weapon1he2', 'weapon1he3', 'cat-weapon-2handed-', 'weapon2hand1', 'weapon2hand2', 'weapon2hand3', 'cat-weapon-missile-', 'weaponmissile1', 'weaponmissile2', 'weaponmissile3', 'cat-weapon-missileartillery-', 'weaponmissileart1', 'weaponmissileart2', 'weaponmissileart3', 'cat-weapon-thrown-', 'weaponthrown1', 'weaponthrown2', 'weaponthrown3', 'cat-weapon-polearms-', 'weaponpolearm1', 'weaponpolearm2', 'weaponpolearm3'];   // list of skills
            _.each(skills, function(skill) {
                //	console.log('/* ---------- event: '+event+' ------------ */');  
                SkillChange(skill+'ranks');
            });
            getSectionIDs('repeating_skills', function(idarray) {
                for (var i=0 ; i<=idarray.length; i++) {
                    SkillChange('repeating_skills_'+ idarray[i]+'_skillranks');
                }
            });
            getSectionIDs('repeating_langs', function(idarray) {
                for (var i=0 ; i<=idarray.length; i++) {
                    SkillChange('repeating_langs_'+ idarray[i]+'_languagewrittenranks');
                    SkillChange('repeating_langs_'+ idarray[i]+'_languagespokenranks');
                }
            });
        }
    });
});

//  <!---- Run the setup to fix the npc Base Hits Code based on npchitscode (depreciated) once when the sheet is first opened ---->
on('sheet:opened', function() {
    getAttrs(['sheetversion', 'currentsheetversion', 'npcbasehitscode', 'npchitscode', 'npcexhaustmiscbonus', 'npchitsperleveldiff', 'npcstaminabonus'], function(values) {
        if (parseFloat(values.sheetversion) < 3.13){
            if (parseFloat(values.npchitscode) == .01){		//-
                setAttrs({
                    npcbasehitscode: 0 
                });
            } else if (parseFloat(values.npchitscode) == .02){		//A
                setAttrs({
                    npcbasehitscode: 1,
                    npcexhaustmiscbonus: 0,
                    npchitsperleveldiff: 1,
                    npcstaminabonus: '-7(01); -5(02-09); -3(10-25); -2(26-30); 0(31-70); 2(71-75); 3(76-92); 5(93-99); 7(100)'
                });
            } else if (parseFloat(values.npchitscode) == .03){		//B
                setAttrs({
                    npcbasehitscode: 2,
                    npcexhaustmiscbonus: 0,
                    npchitsperleveldiff: 2,
                    npcstaminabonus: '-8(01); -7(02-04); -5(05-11); -3(12-31); -2(32-35); 0(36-65); 2(66-69); 3(70-89); 5(90-96); 7(97-99); 8(100)'
                });
            } else if (parseFloat(values.npchitscode) == .04){		//C
                setAttrs({
                    npcbasehitscode: 3,
                    npcexhaustmiscbonus: 0,
                    npchitsperleveldiff: 3,
                    npcstaminabonus: '-10(01); -8(02-03); -7(04-08); -5(09-23); -3(24-74); -2(75-79); 0(75-89); 2(86-89); 3(90-94); 5(95-97); 7(98-99); 8(100)'
                });
            } else if (parseFloat(values.npchitscode) == .05){		//D
                setAttrs({
                    npcbasehitscode: 4,
                    npcexhaustmiscbonus: 0,
                    npchitsperleveldiff: 5,
                    npcstaminabonus: '-10(01); -8(02); -7(03-04); -5(05-09); -3(10-25); -2(26-30); 0(31-70); 2(71-75); 3(76-89); 5(90-94); 7(95-97); 8(98-99); 10(100)'
                });
            } else if (parseFloat(values.npchitscode) == 50){		//E
                setAttrs({
                    npcbasehitscode: 5,
                    npcexhaustmiscbonus: 50,
                    npchitsperleveldiff: 8,
                    npcstaminabonus: '-10(01); -8(02); -7(03-04); -5(05-09); -3(10-24); -2(25-29); 0(30-67); 2(68-72); 3(73-87); 5(88-92); 7(93-95); 8(96-97); 10(98); 12(99); 13(100)'
                });
            } else if (parseFloat(values.npchitscode) == 100){		//F
                setAttrs({
                    npcbasehitscode: 6,
                    npcexhaustmiscbonus: 100,
                    npchitsperleveldiff: 10,
                    npcstaminabonus: '-10(01); -8(02); -7(03); -5(04-05); -3(06-10); -2(11-15); 0(16-20); 2(21-25); 3(26-72); 5(73-87); 7(88-92); 8(93-95); 10(96-97); 12(98); 13(99); 17(100)'
                });
            } else if (parseFloat(values.npchitscode) == 150){		//G
                setAttrs({
                    npcbasehitscode: 7,
                    npcexhaustmiscbonus: 150,
                    npchitsperleveldiff: 12,
                    npcstaminabonus: '-10(01); -8(02); -7(03); -5(04); -3(05-06); -2(07-11); 0(12-16); 2(17-31); 3(32-36); 5(37-71); 7(72-86); 8(87-91); 10(92-94); 12(95-96); 13(97-98); 17(99); 22(100)'
                });
            } else if (parseFloat(values.npchitscode) == 200){		//H
                setAttrs({
                    npcbasehitscode: 8,
                    npcexhaustmiscbonus: 200,
                    npchitsperleveldiff: 15,
                    npcstaminabonus: '-10(01); -8(02); -7(03); -5(04); -3(05); -2(06-07); 0(08-12); 2(13-17); 3(18-32); 5(32-37); 7(38-72); 8(73-88); 10(89-93); 12(94-96); 13(97-98); 17(99); 22(100)'
                });
            } else {
                setAttrs({
                    npcbasehitscode: 0,
                    npcexhaustmiscbonus: 0,
                    npchitsperleveldiff: 0,
                    npcstaminabonus: '-'
                });
            }
        }
    });
});

//  <!---- Run the setup if the npc Base Hits code changes ---->
on('change:npcbasehitscode', function() {
//console.log('------------entering npcbasehitscode change---------------');
    getAttrs(['npcbasehitscode', 'npcexhaustmiscbonus', 'npchitsperleveldiff', 'npcstaminabonus'], function(values) {
        //	console.log('/* ---------- npcbasehitscode: '+values.npcbasehitscode+' ------------ */'); 
        if (parseInt(values.npcbasehitscode, 10) == 1){   //A
            setAttrs({
                npcexhaustmiscbonus: 0,
                npchitsperleveldiff: 1,
                npcstaminabonus: '-7(01); -5(02-09); -3(10-25); -2(26-30); 0(31-70); 2(71-75); 3(76-92); 5(93-99); 7(100)'
            });
        } else if (parseInt(values.npcbasehitscode, 10) == 2){   //B
            setAttrs({
                npcexhaustmiscbonus: 0,
                npchitsperleveldiff: 2,
                npcstaminabonus: '-8(01); -7(02-04); -5(05-11); -3(12-31); -2(32-35); 0(36-65); 2(66-69); 3(70-89); 5(90-96); 7(97-99); 8(100)'
            });
        } else if (parseInt(values.npcbasehitscode, 10) == 3){   //C
            setAttrs({
                npcexhaustmiscbonus: 0,
                npchitsperleveldiff: 3,
                npcstaminabonus: '-10(01); -8(02-03); -7(04-08); -5(09-23); -3(24-74); -2(75-79); 0(75-89); 2(86-89); 3(90-94); 5(95-97); 7(98-99); 8(100)'
            });
        } else if (parseInt(values.npcbasehitscode, 10) == 4){   //D
            setAttrs({
                npcexhaustmiscbonus: 0,
                npchitsperleveldiff: 5,
                npcstaminabonus: '-10(01); -8(02); -7(03-04); -5(05-09); -3(10-25); -2(26-30); 0(31-70); 2(71-75); 3(76-89); 5(90-94); 7(95-97); 8(98-99); 10(100)'
            });
        } else if (parseInt(values.npcbasehitscode, 10) == 5){   //E
            setAttrs({
                npcexhaustmiscbonus: 50,
                npchitsperleveldiff: 8,
                npcstaminabonus: '-10(01); -8(02); -7(03-04); -5(05-09); -3(10-24); -2(25-29); 0(30-67); 2(68-72); 3(73-87); 5(88-92); 7(93-95); 8(96-97); 10(98); 12(99); 13(100)'
            });
        } else if (parseInt(values.npcbasehitscode, 10) == 6){   //F
            setAttrs({
                npcexhaustmiscbonus: 100,
                npchitsperleveldiff: 10,
                npcstaminabonus: '-10(01); -8(02); -7(03); -5(04-05); -3(06-10); -2(11-15); 0(16-20); 2(21-25); 3(26-72); 5(73-87); 7(88-92); 8(93-95); 10(96-97); 12(98); 13(99); 17(100)'
            });
        } else if (parseInt(values.npcbasehitscode, 10)== 7){   //G
            setAttrs({
                npcexhaustmiscbonus: 150,
                npchitsperleveldiff: 12,
                npcstaminabonus: '-10(01); -8(02); -7(03); -5(04); -3(05-06); -2(07-11); 0(12-16); 2(17-31); 3(32-36); 5(37-71); 7(72-86); 8(87-91); 10(92-94); 12(95-96); 13(97-98); 17(99); 22(100)'
            });
        } else if (parseInt(values.npcbasehitscode, 10) == 8){   //H
            setAttrs({
                npcexhaustmiscbonus: 200,
                npchitsperleveldiff: 15,
                npcstaminabonus: '-10(01); -8(02); -7(03); -5(04); -3(05); -2(06-07); 0(08-12); 2(13-17); 3(18-32); 5(32-37); 7(38-72); 8(73-88); 10(89-93); 12(94-96); 13(97-98); 17(99); 22(100)'
            });
        } else {
            setAttrs({
                npcexhaustmiscbonus: 0,
                npchitsperleveldiff: 0,
                npcstaminabonus: '-'
            });
        }
    });
});

//  <!---- Run the setup if the npc Habitat code clear box is clicked ---->
on('change:habitatclear', function() {
    setAttrs({
        habitat1code: 0,
        habitat2code: 0,
        habitat3code: 0,
        habitat4code: 0,
        habitat5code: 0,
        habitat6code: 0,
        habitat7code: 0,
        habitat8code: 0,
        habitat9code: 0,
        habitat10code: 0,
        habitat11code: 0,
        habitat12code: 0,
        habitatclear: 0
    });
});

//  <!---- Run the setup if the npc Environmental Special Features code clear box is clicked ---->
on('change:spfeaturesclear', function() {
    setAttrs({
        spfeatures1code: 0,
        spfeatures2code: 0,
        spfeatures3code: 0,
        spfeatures4code: 0,
        spfeatures5code: 0,
        spfeatures6code: 0,
        spfeatures7code: 0,
        spfeatures8code: 0,
        spfeatures9code: 0,
        spfeatures10code: 0,
        spfeatures11code: 0,
        spfeatures12code: 0,
        spfeaturesclear: 0
    });
});

//  <!---- Run the setup if the npc Environmental Water Sources code clear box is clicked ---->
on('change:watersourcesclear', function() {
    setAttrs({
        watersources1code: 0,
        watersources2code: 0,
        watersources3code: 0,
        watersources4code: 0,
        watersources5code: 0,
        watersources6code: 0,
        watersources7code: 0,
        watersources8code: 0,
        watersources9code: 0,
        watersources10code: 0,
        watersources11code: 0,
        watersources12code: 0,
        watersourcesclear: 0
    });
});

//  <!---- Run the setup if the npc Environmental Terrain code clear box is clicked ---->
on('change:terrainclear', function() {
    setAttrs({
        terrain1code: 0,
        terrain2code: 0,
        terrain3code: 0,
        terrain4code: 0,
        terrain5code: 0,
        terrain6code: 0,
        terrainclear: 0
    });
});

//  <!---- Run the setup if the npc Environmental Vegetation code clear box is clicked ---->
on('change:vegetationclear', function() {
    setAttrs({
        vegetation1code: 0,
        vegetation2code: 0,
        vegetation3code: 0,
        vegetation4code: 0,
        vegetation5code: 0,
        vegetation6code: 0,
        vegetation7code: 0,
        vegetation8code: 0,
        vegetationclear: 0
    });
});

//  <!---- Parse the treasures out of the treasure codes ---->
on('change:treasurecode', function() {
//console.log('------------looks like we got us some treasure, lads---------------');
    getAttrs(['treasurecode'], function(values) {
        //console.log('/* ---------- treasurecode: '+values.treasurecode+' ------------ */');
        var treasure='';
        var count=0;
        if((values.treasurecode)==null)
            values.treasurecode = '-';
        //console.log('/* 0---------- treasurecode: '+values.treasurecode+' ---- treasure: '+values.treasure+'---count:'+values.count+' ------------ */');
        if(values.treasurecode.includes('a')) {
            //console.log('------------it be an a, eh?---------------');
            count=values.treasurecode.split('a').length-1;
            //console.log('/* 1---------- treasure: '+values.treasure+'---count:'+values.count+' ------------ */');
            treasure += count+'x Items= Very Poor & '+ count+'x Wealth = Very Poor; ';
            //console.log('/* 2---------- treasure: '+values.treasure+'---count:'+values.count+' ------------ */');
        }	
        if(values.treasurecode.includes('b')){
            count=values.treasurecode.split('b').length-1;
            treasure += count+'x Items= Very Poor & '+ count+'x Wealth = Poor; ';
        }	
        if(values.treasurecode.includes('c')){
            count=values.treasurecode.split('c').length-1;
            treasure += count+'x Items= Very Poor & '+ count+'x Wealth = Normal; ';
        }	
        if(values.treasurecode.includes('d')){
            count=values.treasurecode.split('d').length-1;
            treasure += count+'x Items= Very Poor & '+ count+'x Wealth = Rich; ';
        }	
        if(values.treasurecode.includes('e')){
            count=values.treasurecode.split('e').length-1;
            treasure += count+'x Items= Very Poor & '+ count+'x Wealth = Very Rich; ';
        }	
        if(values.treasurecode.includes('f')){
            count=values.treasurecode.split('f').length-1;
            treasure += count+'x Items= Poor & '+ count+'x Wealth = Very Poor; ';
        }	
        if(values.treasurecode.includes('g')){
            count=values.treasurecode.split('g').length-1;
            treasure += count+'x Items= Poor & '+ count+'x Wealth = Poor; ';
        }	
        if(values.treasurecode.includes('h')){
            count=values.treasurecode.split('h').length-1;
            treasure += count+'x Items= Poor & '+ count+'x Wealth = Normal; ';
        }	
        if(values.treasurecode.includes('i')){
            count=values.treasurecode.split('i').length-1;
            treasure += count+'x Items= Poor & '+ count+'x Wealth = Rich; ';
        }	
        if(values.treasurecode.includes('j')){
            count=values.treasurecode.split('j').length-1;
            treasure += count+'x Items= Poor & '+ count+'x Wealth = Very Rich; ';
        }	
        if(values.treasurecode.includes('k')){
            count=values.treasurecode.split('k').length-1;
            treasure += count+'x Items= Normal & '+ count+'x Wealth = Very Poor; ';	
        }	
        if(values.treasurecode.includes('l')){
            count=values.treasurecode.split('l').length-1;
            treasure += count+'x Items= Normal & '+ count+'x Wealth = Poor; ';
        }	
        if(values.treasurecode.includes('m')){
            count=values.treasurecode.split('m').length-1;
            treasure += count+'x Items= Normal & '+ count+'x Wealth = Normal; ';
        }	
        if(values.treasurecode.includes('n')){
            count=values.treasurecode.split('n').length-1;
            treasure += count+'x Items= Normal & '+ count+'x Wealth = Rich; ';
        }	
        if(values.treasurecode.includes('o')){
            count=values.treasurecode.split('o').length-1;
            treasure += count+'x Items= Normal & '+ count+'x Wealth = Very Rich; ';
        }	
        if(values.treasurecode.includes('p')){
            count=values.treasurecode.split('p').length-1;
            treasure += count+'x Items= Rich & '+ count+'x Wealth = Very Poor; ';
        }	
        if(values.treasurecode.includes('q')){
            count=values.treasurecode.split('q').length-1;
            treasure += count+'x Items= Rich & '+ count+'x Wealth = Poor; ';
        }	
        if(values.treasurecode.includes('r')){
            count=values.treasurecode.split('r').length-1;
            treasure += count+'x Items= Rich & '+ count+'x Wealth = Normal; ';
        }	
        if(values.treasurecode.includes('s')){
            count=values.treasurecode.split('s').length-1;
            treasure += count+'x Items= Rich & '+ count+'x Wealth = Rich; ';
        }	
        if(values.treasurecode.includes('t')){
            count=values.treasurecode.split('t').length-1;
            treasure += count+'x Items= Rich & '+ count+'x Wealth = Very Rich; ';
        }	
        if(values.treasurecode.includes('u')){
            count=values.treasurecode.split('u').length-1;
            treasure += count+'x Items= Very Rich & '+ count+'x Wealth = Very Poor; ';
        }	
        if(values.treasurecode.includes('v')){
            count=values.treasurecode.split('v').length-1;
            treasure += count+'x Items= Very Rich & '+ count+'x Wealth = Poor; ';
        }	
        if(values.treasurecode.includes('w')){
            count=values.treasurecode.split('w').length-1;
            treasure += count+'x Items= Very Rich & '+ count+'x Wealth = Normal; ';
        }	
        if(values.treasurecode.includes('x')){
            count=values.treasurecode.split('x').length-1;
            treasure += count+'x Items= Very Rich & '+ count+'x Wealth = Rich; ';
        }	
        if(values.treasurecode.includes('y')){
            count=values.treasurecode.split('y').length-1;
            treasure += count+'x Items= Very Rich & '+ count+'x Wealth = Very Rich; ';
        }	
        if(values.treasurecode.includes('z')){
            count=values.treasurecode.split('z').length-1;
            treasure += count+'x Items= Special & '+ count+'x Wealth = Special; ';
        }	
        if(values.treasurecode.includes('*'))
            treasure += 'Special, see description.  ';
        if(values.treasurecode.includes('-'))
            treasure = '--';
        if(values.treasurecode.includes(' '))
            treasure = '-';
        setAttrs({
            npctreasure: treasure
        });
    });
});
//						npctreasure= the treasures  
//						treasurecode= the codes
//  						"Special; see description" = *
//							"Items= Very Poor; Wealth = Very Poor;" = a
//							"Items= Very Poor; Wealth = Poor;" = b
//							"Items= Very Poor; Wealth = Normal;" = c
//							"Items= Very Poor; Wealth = Rich;" = d
//							"Items= Very Poor; Wealth = Very Rich;" = e
//							"Items= Poor; Wealth = Very Poor;" = f
//							"Items= Poor; Wealth = Poor;" = g
//							"Items= Poor; Wealth = Normal;" = h
//							"Items= Poor; Wealth = Rich;" = i
//							"Items= Poor; Wealth = Very Rich;" = j
//							"Items= Normal; Wealth = Very Poor;" = k		
//							"Items= Normal; Wealth = Poor;" = l
//							"Items= Normal; Wealth = Normal;" = m
//							"Items= Normal; Wealth = Rich;" = n
//							"Items= Normal; Wealth = Very Rich;" = o
//							"Items= Rich; Wealth = Very Poor;" = p
//							"Items= Rich; Wealth = Poor;" = q
//							"Items= Rich; Wealth = Normal;" = r
//							"Items= Rich; Wealth = Rich;" = s
//							"Items= Rich; Wealth = Very Rich;" = t
//							"Items= Very Rich; Wealth = Very Poor;" = u
//							"Items= Very Rich; Wealth = Poor;" = v
//							"Items= Very Rich; Wealth = Normal;" = w
//							"Items= Very Rich; Wealth = Rich;" = x
//							"Items= Very Rich; Wealth = Very Rich;" = y
//							"Items= Special; Wealth = Special;" = z


//  <!---- Parse the NPC JSON code to import an NPC ---->
on('change:npcimportcheckbox', function(){
//console.log('------------entering NPC Import change---------------');
    getAttrs(['npcinput','npcimportcheckbox'], function(text) {
        if(text.npcimportcheckbox=='1'){
            var goodcode=true;
            var error='';
            //console.log('------------checkbox is 1---------------');
            try{
                var npcinputfile=JSON.parse(text.npcinput);
            }catch(err){
                goodcode=false;
            }
            if(goodcode){
                var attributes={};
                try{
                    if(npcinputfile.category!=null)
                        attributes.npccategory=npcinputfile.category;
                    if(npcinputfile.type!=null)
                        attributes.type=npcinputfile.type;
                    if(npcinputfile.class!=null)
                        attributes.class=npcinputfile.class;
                    if(npcinputfile.level!=null)
                        attributes.npclevel=npcinputfile.level;
                    if(npcinputfile.levelcode!=null)
                        attributes.levelcode=npcinputfile.levelcode;
                    if(npcinputfile.carrycapacity!=null)
                        attributes.npccarrycapacity=npcinputfile.carrycapacity;
                    if(npcinputfile.ridingbonus!=null)
                        attributes.npcridingbonus=npcinputfile.ridingbonus;
                    if(npcinputfile.description!=null)
                        attributes.npcdescription=npcinputfile.description;
                    if(npcinputfile.lifestyle!=null)
                        attributes.npclifestyle=npcinputfile.lifestyle;
                    if(npcinputfile.combat!=null)
                        attributes.npccombatnotes=npcinputfile.combat;
                    if(npcinputfile.background!=null)
                        attributes.npcbackgroundnotes=npcinputfile.background;
                    if(npcinputfile.observations!=null)
                        attributes.npcobservationsnotes=npcinputfile.observations;
                    if(npcinputfile.notes!=null)
                        attributes.npcothernotes=npcinputfile.notes;
                    if(npcinputfile.numenc!=null)
                        attributes.npcnumenc=npcinputfile.numenc;
                    if(npcinputfile.height!=null)
                        attributes.npcheight=npcinputfile.height;
                    if(npcinputfile.offspring!=null)
                        attributes.npcoffspring=npcinputfile.offspring;
                    if(npcinputfile.treasure!=null){
                        attributes.treasurecode=npcinputfile.treasure;
                    }
                    if(npcinputfile.bonusxp!=null){
                        if(npcinputfile.bonusxp=='-'){
                            attributes.bonusxpcode='  --(1-2)/   --(3)/   --(5)/   --(7)/   --(9)/   --(11)/   --(13)/   --(15)/   --(17)/   --(19)/   --(21+)';
                        }else if(npcinputfile.bonusxp=='A'){
                            attributes.bonusxpcode='  50(1-2)/   40(3)/   30(5)/   20(7)/   10(9)/   --(11)/   --(13)/   --(15)/   --(17)/   --(19)/   --(21+)';
                        }else if(npcinputfile.bonusxp=='B'){
                            attributes.bonusxpcode='  75(1-2)/   60(3)/   50(5)/   40(7)/   30(9)/   20(11)/   10(13)/   --(15)/   --(17)/   --(19)/   --(21+)';
                        }else if(npcinputfile.bonusxp=='C'){
                            attributes.bonusxpcode=' 100(1-2)/   95(3)/   90(5)/   85(7)/   80(9)/   75(11)/   70(13)/   65(15)/   60(17)/   55(19)/   50(21+)';
                        }else if(npcinputfile.bonusxp=='D'){
                            attributes.bonusxpcode=' 200(1-2)/  190(3)/  180(5)/  170(7)/  160(9)/  150(11)/  140(13)/  130(15)/  120(17)/  110(19)/  100(21+)';
                        }else if(npcinputfile.bonusxp=='E'){
                            attributes.bonusxpcode=' 400(1-2)/  380(3)/  360(5)/  340(7)/  320(9)/  300(11)/  280(13)/  260(15)/  240(17)/  220(19)/  210(21+)';
                        }else if(npcinputfile.bonusxp=='F'){
                            attributes.bonusxpcode=' 800(1-2)/  760(3)/  720(5)/  680(7)/  640(9)/  600(11)/  560(13)/  520(15)/  480(17)/  440(19)/  400(21+)';
                        }else if(npcinputfile.bonusxp=='G'){
                            attributes.bonusxpcode='1200(1-2)/ 1140(3)/ 1080(5)/ 1020(7)/  960(9)/  900(11)/  840(13)/  780(15)/  720(17)/  660(19)/  600(21+)';
                        }else if(npcinputfile.bonusxp=='H'){
                            attributes.bonusxpcode='1600(1-2)/ 1520(3)/ 1440(5)/ 1360(7)/ 1280(9)/ 1200(11)/ 1120(13)/ 1040(15)/  960(17)/  880(19)/  800(21+)';
                        }else if(npcinputfile.bonusxp=='I'){
                            attributes.bonusxpcode='2000(1-2)/ 1900(3)/ 1800(5)/ 1700(7)/ 1600(9)/ 1500(11)/ 1400(13)/ 1300(15)/ 1200(17)/ 1100(19)/ 1000(21+)';
                        }else if(npcinputfile.bonusxp=='J'){
                            attributes.bonusxpcode='3000(1-2)/ 2850(3)/ 2700(5)/ 2550(7)/ 2400(9)/ 2250(11)/ 2100(13)/ 1950(15)/ 1800(17)/ 1650(19)/ 1500(21+)';
                        }else if(npcinputfile.bonusxp=='K'){
                            attributes.bonusxpcode='4000(1-2)/ 3800(3)/ 3600(5)/ 3400(7)/ 3200(9)/ 3000(11)/ 2800(13)/ 2600(15)/ 2400(17)/ 2200(19)/ 2000(21+)';
                        }else if(npcinputfile.bonusxp=='L'){
                            attributes.bonusxpcode='5000(1-2)/ 4750(3)/ 4500(5)/ 4250(7)/ 4000(9)/ 3750(11)/ 3500(13)/ 3250(15)/ 3000(17)/ 2750(19)/ 2500(21+)';
                        }else {
                            attributes.bonusxpcode='  --(1-2)/   --(3)/   --(5)/   --(7)/   --(9)/   --(11)/   --(13)/   --(15)/   --(17)/   --(19)/   --(21+)';
                        }
                    }
                    if(npcinputfile.outlook!=null){
                        if(npcinputfile.outlook=='-'){
                            attributes.outlookcode='---';
                        }else if(npcinputfile.outlook=='---'){
                            attributes.outlookcode='---';
                        }else if(npcinputfile.outlook=='Aggres'){
                            attributes.outlookcode='Aggressive and will attack if provoked or hungry.';
                        }else if(npcinputfile.outlook=='Agress'){
                            attributes.outlookcode='Aggressive and will attack if provoked or hungry.';
                        }else if(npcinputfile.outlook=='Agress.'){
                            attributes.outlookcode='Aggressive and will attack if provoked or hungry.';
                        }else if(npcinputfile.outlook=='Aggres.'){
                            attributes.outlookcode='Aggressive and will attack if provoked or hungry.';
                        }else if(npcinputfile.outlook=='Aloof'){
                            attributes.outlookcode='Ignores other creatures unless interfered with or attacked.';
                        }else if(npcinputfile.outlook=='Altru'){
                            attributes.outlookcode='Altruistic, has an unselfish regard for the interests of others, often to the extent of risking own safety.';
                        }else if(npcinputfile.outlook=='Altru.'){
                            attributes.outlookcode='Altruistic, has an unselfish regard for the interests of others, often to the extent of risking own safety.';
                        }else if(npcinputfile.outlook=='Belig'){
                            attributes.outlookcode='Belligerent, often attacks without provocation.';
                        }else if(npcinputfile.outlook=='Belig.'){
                            attributes.outlookcode='Belligerent, often attacks without provocation.';
                        }else if(npcinputfile.outlook=='Bellig'){
                            attributes.outlookcode='Belligerent, often attacks without provocation.';
                        }else if(npcinputfile.outlook=='Bellig.'){
                            attributes.outlookcode='Belligerent, often attacks without provocation.';
                        }else if(npcinputfile.outlook=='Berserk'){
                            attributes.outlookcode='Attacks closest living creature until it is destroyed.';
                        }else if(npcinputfile.outlook=='Carefree'){
                            attributes.outlookcode='Does not believe danger or misfortune exists for it.';
                        }else if(npcinputfile.outlook=='Cruel'){
                            attributes.outlookcode='Not only hostile, but delights in death, pain, and suffering.';
                        }else if(npcinputfile.outlook=='Domin'){
                            attributes.outlookcode='Desires power, attempts to control or dominate other creatures.';
                        }else if(npcinputfile.outlook=='Domin.'){
                            attributes.outlookcode='Desires power, attempts to control or dominate other creatures.';
                        }else if(npcinputfile.outlook=='Good'){
                            attributes.outlookcode='Opposed to those who are evil(cruel, hostile, belligerent, etc); supportive of those who are also good.';
                        }else if(npcinputfile.outlook=='Greedy'){
                            attributes.outlookcode='Will attack or attempt to steal from other creatures if risk does not seem too high.';
                        }else if(npcinputfile.outlook=='Hostile'){
                            attributes.outlookcode='Normally attacks other creatures on sight.';
                        }else if(npcinputfile.outlook=='Hungry'){
                            attributes.outlookcode='If hungry, will attack anything edible; otherwise normal.';
                        }else if(npcinputfile.outlook=='Inquis'){
                            attributes.outlookcode='Inquisitive and curious; will approach and examine unusual situations.';
                        }else if(npcinputfile.outlook=='Inquis.'){
                            attributes.outlookcode='Inquisitive and curious; will approach and examine unusual situations.';
                        }else if(npcinputfile.outlook=='Jumpy'){
                            attributes.outlookcode='Normally bolts at any sign of other creatures.';
                        }else if(npcinputfile.outlook=='Mission'){
                            attributes.outlookcode='Created with a specific purpose or mission.';
                        }else if(npcinputfile.outlook=='Normal'){
                            attributes.outlookcode='Watches and is wary of other creatures; will sometimes attack if hungry.';
                        }else if(npcinputfile.outlook=='Passive'){
                            attributes.outlookcode='Ignores the presence of other creatures unless threatened.';
                        }else if(npcinputfile.outlook=='Playful'){
                            attributes.outlookcode='Mischievous but playful; will attempt to play with or play pranks on other creatures.';
                        }else if(npcinputfile.outlook=='Protect'){
                            attributes.outlookcode='Protective of a thing, place, other creature, etc.';
                        }else if(npcinputfile.outlook=='Timid'){
                            attributes.outlookcode='Skittish around other creatures, runs at the slightest hint of danger.';
                        }else if(npcinputfile.outlook=='Varies'){
                            attributes.outlookcode='Varies by individual.';
                        }else if(npcinputfile.outlook=='Special'){
                            attributes.outlookcode='See description.';
                        }else {
                            attributes.outlookcode='Unknown';
                        }
                    }
                    if(npcinputfile.iq!=null){
                        if(npcinputfile.iq=='NO'){
                            attributes.iqcode='None; Animal Instincts';
                        }else if(npcinputfile.iq=='VL'){
                            attributes.iqcode='Very Low; Re/Me=1-5';
                        }else if(npcinputfile.iq=='LO'){
                            attributes.iqcode='Low; Re/Me=3-12';
                        }else if(npcinputfile.iq=='LI'){
                            attributes.iqcode='Little; Re/Me=7-25';
                        }else if(npcinputfile.iq=='IN'){
                            attributes.iqcode='Inferior; Re/Me=13-40';
                        }else if(npcinputfile.iq=='MD'){
                            attributes.iqcode='Mediocre; Re/Me=23-50';
                        }else if(npcinputfile.iq=='AV'){
                            attributes.iqcode='Average; Re/Me=35-65';
                        }else if(npcinputfile.iq=='AA'){
                            attributes.iqcode='Above Average; Re/Me=50-77';
                        }else if(npcinputfile.iq=='SU'){
                            attributes.iqcode='Superior; Re/Me=60-86';
                        }else if(npcinputfile.iq=='HI'){
                            attributes.iqcode='High; Re/Me=80-98';
                        }else if(npcinputfile.iq=='VH'){
                            attributes.iqcode='Very High; Re/Me=94-99';
                        }else if(npcinputfile.iq=='EX'){
                            attributes.iqcode='Exceptional; Re/Me=100-102';
                        }else if(npcinputfile.iq=='*'){
                            attributes.iqcode='*';
                        }else {
                            attributes.iqcode='Unknown';
                        }
                    }
                    if(npcinputfile.habitat!=null){
                        if(npcinputfile.habitat.includes('-')){
                            attributes.habitat1code='1';
                        }else if(npcinputfile.habitat.includes('')){
                            attributes.habitat2code='1';
                        }else if(npcinputfile.habitat.includes('(')){
                            attributes.habitat3code='1';
                            attributes.habitat4code='1';
                            attributes.habitat5code='1';
                            attributes.habitat6code='1';
                            attributes.habitat7code='1';
                            attributes.habitat8code='1';
                            attributes.habitat9code='1';
                            attributes.habitat10code='1';
                            attributes.habitat11code='1';
                            attributes.habitat12code='1';
                            state='0';
                        }else {
                            state='1';
                        }
                        if(npcinputfile.habitat.includes('a'))
                            attributes.habitat5code=state;
                        if(npcinputfile.habitat.includes('c'))
                            attributes.habitat11code=state;
                        if(npcinputfile.habitat.includes('f'))
                            attributes.habitat12code=state;
                        if(npcinputfile.habitat.includes('h'))
                            attributes.habitat3code=state;
                        if(npcinputfile.habitat.includes('k'))
                            attributes.habitat9code=state;
                        if(npcinputfile.habitat.includes('m'))
                            attributes.habitat7code=state;
                        if(npcinputfile.habitat.includes('n'))
                            attributes.habitat4code=state;
                        if(npcinputfile.habitat.includes('s'))
                            attributes.habitat8code=state;
                        if(npcinputfile.habitat.includes('t'))
                            attributes.habitat10code=state;
                        if(npcinputfile.habitat.includes('w'))
                            attributes.habitat6code=state;
                    }
                    if(npcinputfile.specialfeatures!=null){
                        if(npcinputfile.specialfeatures.includes('-')){
                            attributes.spfeatures1code='1';
                        }else if(npcinputfile.specialfeatures.includes('')){
                            attributes.spfeatures2code='1';
                        }else if(npcinputfile.specialfeatures.includes('(')){
                            attributes.spfeatures3code='1';
                            attributes.spfeatures4code='1';
                            attributes.spfeatures5code='1';
                            attributes.spfeatures6code='1';
                            attributes.spfeatures7code='1';
                            attributes.spfeatures8code='1';
                            attributes.spfeatures9code='1';
                            attributes.spfeatures10code='1';
                            attributes.spfeatures11code='1';
                            attributes.spfeatures12code='1';
                            state='0';
                        }else {
                            state='1';
                        }
                        if(npcinputfile.specialfeatures.includes('E'))
                            attributes.spfeatures3code=state;
                        if(npcinputfile.specialfeatures.includes('K'))
                            attributes.spfeatures4code=state;
                        if(npcinputfile.specialfeatures.includes('N'))
                            attributes.spfeatures5code=state;
                        if(npcinputfile.specialfeatures.includes('V'))
                            attributes.spfeatures6code=state;
                        if(npcinputfile.specialfeatures.includes('X'))
                            attributes.spfeatures7code=state;
                        if(npcinputfile.specialfeatures.includes('Y'))
                            attributes.spfeatures8code=state;
                        if(npcinputfile.specialfeatures.includes(''))
                            attributes.spfeatures9code=state;
                        if(npcinputfile.specialfeatures.includes('@'))
                            attributes.spfeatures10code=state;
                        if(npcinputfile.specialfeatures.includes(''))
                            attributes.spfeatures11code=state;
                        if(npcinputfile.specialfeatures.includes('#'))
                            attributes.spfeatures12code=state;
                    }
                    if(npcinputfile.watersources!=null){
                        if(npcinputfile.watersources.includes('-')){
                            attributes.watersources1code='1';
                        }else if(npcinputfile.watersources.includes('')){
                            attributes.watersources2code='1';
                        }else if(npcinputfile.watersources.includes('(')){
                            attributes.watersources3code='1';
                            attributes.watersources4code='1';
                            attributes.watersources5code='1';
                            attributes.watersources6code='1';
                            attributes.watersources7code='1';
                            attributes.watersources8code='1';
                            attributes.watersources9code='1';
                            attributes.watersources10code='1';
                            attributes.watersources11code='1';
                            attributes.watersources12code='1';
                            state='0';
                        }else {
                            state='1';
                        }
                        if(npcinputfile.watersources.includes('B'))
                            attributes.watersources3code=state;
                        if(npcinputfile.watersources.includes('F'))
                            attributes.watersources4code=state;
                        if(npcinputfile.watersources.includes('G'))
                            attributes.watersources5code=state;
                        if(npcinputfile.watersources.includes('I'))
                            attributes.watersources6code=state;
                        if(npcinputfile.watersources.includes('L'))
                            attributes.watersources7code=state;
                        if(npcinputfile.watersources.includes('M'))
                            attributes.watersources8code=state;
                        if(npcinputfile.watersources.includes('O'))
                            attributes.watersources9code=state;
                        if(npcinputfile.watersources.includes('Q'))
                            attributes.watersources10code=state;
                        if(npcinputfile.watersources.includes('S'))
                            attributes.watersources11code=state;
                        if(npcinputfile.watersources.includes('Z'))
                            attributes.watersources12code=state;
                    }
                    if(npcinputfile.terrain!=null){
                        if(npcinputfile.terrain.includes('-')){
                            attributes.terrain1code='1';
                        }else if(npcinputfile.terrain.includes('')){
                            attributes.terrain2code='1';
                        }else if(npcinputfile.terrain.includes('(')){
                            attributes.terrain3code='1';
                            attributes.terrain4code='1';
                            attributes.terrain5code='1';
                            attributes.terrain6code='1';
                            state='0';
                        }else {
                            state='1';
                        }
                        if(npcinputfile.terrain.includes('A'))
                            attributes.terrain3code=state;
                        if(npcinputfile.terrain.includes('R'))
                            attributes.terrain4code=state;
                        if(npcinputfile.terrain.includes('U'))
                            attributes.terrain5code=state;
                        if(npcinputfile.terrain.includes('W'))
                            attributes.terrain6code=state;
                    }
                    if(npcinputfile.vegetation!=null){
                        if(npcinputfile.vegetation.includes('-')){
                            attributes.vegetation1code='1';
                        }else if(npcinputfile.vegetation.includes('')){
                            attributes.vegetation2code='1';
                        }else if(npcinputfile.vegetation.includes('(')){
                            attributes.vegetation3code='1';
                            attributes.vegetation4code='1';
                            attributes.vegetation5code='1';
                            attributes.vegetation6code='1';
                            attributes.vegetation7code='1';
                            attributes.vegetation8code='1';
                            state='0';
                        }else {
                            state='1';
                        }
                        if(npcinputfile.vegetation.includes('C'))
                            attributes.vegetation3code=state;
                        if(npcinputfile.vegetation.includes('D'))
                            attributes.vegetation4code=state;
                        if(npcinputfile.vegetation.includes('H'))
                            attributes.vegetation5code=state;
                        if(npcinputfile.vegetation.includes('J'))
                            attributes.vegetation6code=state;
                        if(npcinputfile.vegetation.includes('P'))
                            attributes.vegetation7code=state;
                        if(npcinputfile.vegetation.includes('T'))
                            attributes.vegetation8code=state;
                    }
                    if(npcinputfile.frequency!=null){
                        if(npcinputfile.frequency=='1'){
                            attributes.frequencycode='Hunting modifier=+30; Frequency Occurring=100%';
                        }else if(npcinputfile.frequency=='2'){
                            attributes.frequencycode='Hunting modifier=+20; Frequency Occurring=90%';
                        }else if(npcinputfile.frequency=='3'){
                            attributes.frequencycode='Hunting modifier=+10; Frequency Occurring=75%';
                        }else if(npcinputfile.frequency=='4'){
                            attributes.frequencycode='Hunting modifier=+0;   Frequency Occurring=50%';
                        }else if(npcinputfile.frequency=='5'){
                            attributes.frequencycode='Hunting modifier=-10; Frequency Occurring=40%';
                        }else if(npcinputfile.frequency=='6'){
                            attributes.frequencycode='Hunting modifier=-20; Frequency Occurring=30%';
                        }else if(npcinputfile.frequency=='7'){
                            attributes.frequencycode='Hunting modifier=-30; Frequency Occurring=20%';
                        }else if(npcinputfile.frequency=='8'){
                            attributes.frequencycode='Hunting modifier=-50; Frequency Occurring=9%';
                        }else if(npcinputfile.frequency=='9'){
                            attributes.frequencycode='Hunting modifier=-70; Frequency Occurring=4%';
                        }else {
                            attributes.frequencycode='Unknown';
                        }
                    }
                    attributes.frequency=npcinputfile.frequency;
                    if(npcinputfile.size!=null)
                        attributes.npcsize=npcinputfile.size;
                    if(npcinputfile.basemove!=null)
                        attributes.npcbmmr=npcinputfile.basemove;
                    if(npcinputfile.maxpace!=null){
                        if(npcinputfile.maxpace=='Walk'){
                            attributes.npcmaxpace='1';
                        }else if(npcinputfile.maxpace=='Jog'){
                            attributes.npcmaxpace='1.5';
                        }else if(npcinputfile.maxpace=='Run'){
                            attributes.npcmaxpace='2';
                        }else if(npcinputfile.maxpace=='Spt'){
                            attributes.npcmaxpace='3';
                        }else if(npcinputfile.maxpace=='FSpt'){
                            attributes.npcmaxpace='4';
                        }else if(npcinputfile.maxpace=='Dash'){
                            attributes.npcmaxpace='5';
                        }else if(npcinputfile.maxpace=='Var'){
                            attributes.npcmaxpace='0 [varies]';
                        }else {
                            attributes.npcmaxpace='Unknown';
                        }
                    }
                    if(npcinputfile.mmbonus!=null)
                        attributes.npcmmbonus=npcinputfile.mmbonus;
                    if(npcinputfile.ms!=null){
                        if(npcinputfile.ms=='IN'){
                            attributes.npcms='-25';
                        }else if(npcinputfile.ms=='CR'){
                            attributes.npcms='-20';
                        }else if(npcinputfile.ms=='VS'){
                            attributes.npcms='-10';
                        }else if(npcinputfile.ms=='SL'){
                            attributes.npcms='0';
                        }else if(npcinputfile.ms=='MD'){
                            attributes.npcms='10';
                        }else if(npcinputfile.ms=='MF'){
                            attributes.npcms='20';
                        }else if(npcinputfile.ms=='FA'){
                            attributes.npcms='30';
                        }else if(npcinputfile.ms=='VF'){
                            attributes.npcms='40';
                        }else if(npcinputfile.ms=='BF'){
                            attributes.npcms='50';
                        }else {
                            attributes.npcms='0.5';
                        }
                    }
                    if(npcinputfile.aq!=null){
                        if(npcinputfile.aq=='IN'){
                            attributes.npcaq='-16';
                        }else if(npcinputfile.aq=='CR'){
                            attributes.npcaq='-12';
                        }else if(npcinputfile.aq=='VS'){
                            attributes.npcaq='-8';
                        }else if(npcinputfile.aq=='SL'){
                            attributes.npcaq='-4';
                        }else if(npcinputfile.aq=='MD'){
                            attributes.npcaq='0';
                        }else if(npcinputfile.aq=='MF'){
                            attributes.npcaq='4';
                        }else if(npcinputfile.aq=='FA'){
                            attributes.npcaq='8';
                        }else if(npcinputfile.aq=='VF'){
                            attributes.npcaq='12';
                        }else if(npcinputfile.aq=='BF'){
                            attributes.npcaq='16';
                        }else {
                            attributes.npcaq='0.5';
                        }
                    }
                    if(npcinputfile.hits!=null){
                        attributes.npchitpoints=npcinputfile.hits;
                        attributes.npchitpoints_max=npcinputfile.hits;
                    }
                    if(npcinputfile.hitcode!=null){
                        if(npcinputfile.hitcode=='A'){
                            attributes.npcbasehitscode='1';
                        } else if(npcinputfile.hitcode=='B'){
                            attributes.npcbasehitscode='2';
                        } else if(npcinputfile.hitcode=='C'){
                            attributes.npcbasehitscode='3';
                        } else if(npcinputfile.hitcode=='D'){
                            attributes.npcbasehitscode='4';
                        } else if(npcinputfile.hitcode=='E'){
                            attributes.npcbasehitscode='5';
                        } else if(npcinputfile.hitcode=='F'){
                            attributes.npcbasehitscode='6';
                        } else if(npcinputfile.hitcode=='G'){
                            attributes.npcbasehitscode='7';
                        } else if(npcinputfile.hitcode=='H'){
                            attributes.npcbasehitscode='8';
                        } else {
                            attributes.npcbasehitscode='0';
                        }
                    }	
                    if(npcinputfile.crit!=null){
                        if(npcinputfile.crit=='I'){
                            attributes.npccritscode1='Decrease crit severity by 1 (A mod by -20; B becomes A, etc.).';
                        } else if(npcinputfile.crit=='II'){
                            attributes.npccritscode1='Decrease crit severity by 2 (A mod by -50; B by -20; C becomes A, etc).';
                        } else if(npcinputfile.crit=='LA'){
                            attributes.npccritscode1='Use Large Creature Critical Strike Table.';
                        } else if(npcinputfile.crit=='SL'){
                            attributes.npccritscode1='Use Super Large Creature Critical Strike Table.';
                        } else if(npcinputfile.crit=='-'){
                            attributes.npccritscode1='Normal crits.';
                        } else {
                            attributes.npccritscode1='Normal crits.';
                        }
                    }
                    if(npcinputfile.critcode!=null){
                        if(npcinputfile.critcode=='-'){
                            attributes.npccritscode2='---';
                        } else if(npcinputfile.critcode=='@'){
                            attributes.npccritscode2='Stun results do not affect creature.';
                        } else if(npcinputfile.critcode=='#'){
                            attributes.npccritscode2='Stun results and bleeders do not affect creature.';
                        } else {
                            attributes.npccritscode2='---';
                        }
                    }
                    if(npcinputfile.at!=null)
                        attributes.npcat=npcinputfile.at;
                    if(npcinputfile.db!=null)
                        attributes.npcdb=npcinputfile.db;
                    if(npcinputfile.othercombatinformation!=null)
                        attributes.npcspecialdefences=npcinputfile.othercombatinformation;
                    // <<<<<<<<<<<<<<<<<<<<<<<<<<< Attack Parsing Stuff >>>>>>>>>>>>>>>>>>>>>>>>>>>
                    if(npcinputfile.attack!=null)						// old attack field
                        attributes.npcatts=npcinputfile.attack;
                    if(npcinputfile.attack1name!=null)					
                        attributes.npcattack1name=npcinputfile.attack1name;
                    if(npcinputfile.attack1ob!=null)
                        attributes.npcattack1bonus=npcinputfile.attack1ob;
                    if(npcinputfile.attack1perc!=null)					
                        attributes.npcattack1percent=npcinputfile.attack1perc;
                    if(npcinputfile.attack1type!=null){
                        if(npcinputfile.attack1type=='Melee'){
                            attributes.npcattack1select='npcmelee';
                            attributes.npcattack1type='[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
                            attributes.npcattack1rolltype='1d100!>@{oeuproll}cf<@{npcattack1fumble}';
                            attributes.npcattack1attackcalc='@{npcattack1bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]';
                        } else if(npcinputfile.attack1type=='Ranged'){
                            attributes.npcattack1select='npcranged';
                            attributes.npcattack1type='[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
                            attributes.npcattack1rolltype='1d100!>@{oeuproll}cf<@{npcattack1fumble}';
                            attributes.npcattack1attackcalc='@{npcattack1bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action]';
                        } else if(npcinputfile.attack1type=='Basic Spell'){
                            attributes.npcattack1select='npcbasic';
                            attributes.npcattack1type='[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
                            attributes.npcattack1rolltype='1d100cf<2cs>96';
                            attributes.npcattack1attackcalc='@{npcattack1bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}';
                        } else if(npcinputfile.attack1type=='Directed Spell'){
                            attributes.npcattack1select='npcdirected';
                            attributes.npcattack1type='[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
                            attributes.npcattack1rolltype='1d100!>@{oeuproll}cf<2cs=100';
                            attributes.npcattack1attackcalc='@{npcattack1bonus}Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                        } else if(npcinputfile.attack1type=='Area Spell'){
                            attributes.npcattack1select='npcarea';
                            attributes.npcattack1type='[[@{npcattack1rolltype} +@{npcattack1attackcalc}]]';
                            attributes.npcattack1rolltype='1d100cf<4cs>96';
                            attributes.npcattack1attackcalc='@{npcattack1bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]';
                        } else {
                            attributes.npcattack1select='none';
                        }
                    }
                    if(npcinputfile.attack2name!=null)					
                        attributes.npcattack2name=npcinputfile.attack2name;
                    if(npcinputfile.attack2ob!=null)
                        attributes.npcattack2bonus=npcinputfile.attack2ob;
                    if(npcinputfile.attack2perc!=null)					
                        attributes.npcattack2percent=npcinputfile.attack2perc;
                    if(npcinputfile.attack2type!=null){
                        if(npcinputfile.attack2type=='Melee'){
                            attributes.npcattack2select='npcmelee';
                            attributes.npcattack2type='[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
                            attributes.npcattack2rolltype='1d100!>@{oeuproll}cf<@{npcattack2fumble}';
                            attributes.npcattack2attackcalc='@{npcattack2bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]';
                        } else if(npcinputfile.attack2type=='Ranged'){
                            attributes.npcattack2select='npcranged';
                            attributes.npcattack2type='[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
                            attributes.npcattack2rolltype='1d100!>@{oeuproll}cf<@{npcattack2fumble}';
                            attributes.npcattack2attackcalc='@{npcattack2bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action]';
                        } else if(npcinputfile.attack2type=='Basic Spell'){
                            attributes.npcattack2select='npcbasic';
                            attributes.npcattack2type='[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
                            attributes.npcattack2rolltype='1d100cf<2cs>96';
                            attributes.npcattack2attackcalc='@{npcattack2bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}';
                        } else if(npcinputfile.attack2type=='Directed Spell'){
                            attributes.npcattack2select='npcdirected';
                            attributes.npcattack2type='[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
                            attributes.npcattack2rolltype='1d100!>@{oeuproll}cf<2cs=100';
                            attributes.npcattack2attackcalc='@{npcattack2bonus}Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                        } else if(npcinputfile.attack2type=='Area Spell'){
                            attributes.npcattack2select='npcarea';
                            attributes.npcattack2type='[[@{npcattack2rolltype} +@{npcattack2attackcalc}]]';
                            attributes.npcattack2rolltype='1d100cf<4cs>96';
                            attributes.npcattack2attackcalc='@{npcattack2bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]';
                        } else {
                            attributes.npcattack2select='none';
                        }
                    }
                    if(npcinputfile.attack3name!=null)					
                        attributes.npcattack3name=npcinputfile.attack3name;
                    if(npcinputfile.attack3ob!=null)
                        attributes.npcattack3bonus=npcinputfile.attack3ob;
                    if(npcinputfile.attack3perc!=null)					
                        attributes.npcattack3percent=npcinputfile.attack3perc;
                    if(npcinputfile.attack3type!=null){
                        if(npcinputfile.attack3type=='Melee'){
                            attributes.npcattack3select='npcmelee';
                            attributes.npcattack3type='[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
                            attributes.npcattack3rolltype='1d100!>@{oeuproll}cf<@{npcattack3fumble}';
                            attributes.npcattack3attackcalc='@{npcattack3bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]';
                        } else if(npcinputfile.attack3type=='Ranged'){
                            attributes.npcattack3select='npcranged';
                            attributes.npcattack3type='[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
                            attributes.npcattack3rolltype='1d100!>@{oeuproll}cf<@{npcattack3fumble}';
                            attributes.npcattack3attackcalc='@{npcattack3bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action]';
                        } else if(npcinputfile.attack3type=='Basic Spell'){
                            attributes.npcattack3select='npcbasic';
                            attributes.npcattack3type='[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
                            attributes.npcattack3rolltype='1d100cf<2cs>96';
                            attributes.npcattack3attackcalc='@{npcattack3bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}';
                        } else if(npcinputfile.attack3type=='Directed Spell'){
                            attributes.npcattack3select='npcdirected';
                            attributes.npcattack3type='[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
                            attributes.npcattack3rolltype='1d100!>@{oeuproll}cf<2cs=100';
                            attributes.npcattack3attackcalc='@{npcattack3bonus}Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                        } else if(npcinputfile.attack3type=='Area Spell'){
                            attributes.npcattack3select='npcarea';
                            attributes.npcattack3type='[[@{npcattack3rolltype} +@{npcattack3attackcalc}]]';
                            attributes.npcattack3rolltype='1d100cf<4cs>96';
                            attributes.npcattack3attackcalc='@{npcattack3bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]';
                        } else {
                            attributes.npcattack3select='none';
                        }
                    }
                    if(npcinputfile.attack4name!=null)					
                        attributes.npcattack4name=npcinputfile.attack4name;
                    if(npcinputfile.attack4ob!=null)
                        attributes.npcattack4bonus=npcinputfile.attack4ob;
                    if(npcinputfile.attack4perc!=null)					
                        attributes.npcattack4percent=npcinputfile.attack4perc;
                    if(npcinputfile.attack4type!=null){
                        if(npcinputfile.attack4type=='Melee'){
                            attributes.npcattack4select='npcmelee';
                            attributes.npcattack4type='[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
                            attributes.npcattack4rolltype='1d100!>@{oeuproll}cf<@{npcattack4fumble}';
                            attributes.npcattack4attackcalc='@{npcattack4bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]';
                        } else if(npcinputfile.attack4type=='Ranged'){
                            attributes.npcattack4select='npcranged';
                            attributes.npcattack4type='[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
                            attributes.npcattack4rolltype='1d100!>@{oeuproll}cf<@{npcattack4fumble}';
                            attributes.npcattack4attackcalc='@{npcattack4bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action]';
                        } else if(npcinputfile.attack4type=='Basic Spell'){
                            attributes.npcattack4select='npcbasic';
                            attributes.npcattack4type='[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
                            attributes.npcattack4rolltype='1d100cf<2cs>96';
                            attributes.npcattack4attackcalc='@{npcattack4bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}';
                        } else if(npcinputfile.attack4type=='Directed Spell'){
                            attributes.npcattack4select='npcdirected';
                            attributes.npcattack4type='[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
                            attributes.npcattack4rolltype='1d100!>@{oeuproll}cf<2cs=100';
                            attributes.npcattack4attackcalc='@{npcattack4bonus}Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                        } else if(npcinputfile.attack4type=='Area Spell'){
                            attributes.npcattack4select='npcarea';
                            attributes.npcattack4type='[[@{npcattack4rolltype} +@{npcattack4attackcalc}]]';
                            attributes.npcattack4rolltype='1d100cf<4cs>96';
                            attributes.npcattack4attackcalc='@{npcattack4bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]';
                        } else {
                            attributes.npcattack4select='none';
                        }
                    }
                    if(npcinputfile.attack5name!=null)					
                        attributes.npcattack5name=npcinputfile.attack5name;
                    if(npcinputfile.attack5ob!=null)
                        attributes.npcattack5bonus=npcinputfile.attack5ob;
                    if(npcinputfile.attack5perc!=null)					
                        attributes.npcattack5percent=npcinputfile.attack5perc;
                    if(npcinputfile.attack5type!=null){
                        if(npcinputfile.attack5type=='Melee'){
                            attributes.npcattack5select='npcmelee';
                            attributes.npcattack5type='[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
                            attributes.npcattack5rolltype='1d100!>@{oeuproll}cf<@{npcattack5fumble}';
                            attributes.npcattack5attackcalc='@{npcattack5bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]';
                        } else if(npcinputfile.attack5type=='Ranged'){
                            attributes.npcattack5select='npcranged';
                            attributes.npcattack5type='[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
                            attributes.npcattack5rolltype='1d100!>@{oeuproll}cf<@{npcattack5fumble}';
                            attributes.npcattack5attackcalc='@{npcattack5bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action]';
                        } else if(npcinputfile.attack5type=='Basic Spell'){
                            attributes.npcattack5select='npcbasic';
                            attributes.npcattack5type='[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
                            attributes.npcattack5rolltype='1d100cf<2cs>96';
                            attributes.npcattack5attackcalc='@{npcattack5bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}';
                        } else if(npcinputfile.attack5type=='Directed Spell'){
                            attributes.npcattack5select='npcdirected';
                            attributes.npcattack5type='[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
                            attributes.npcattack5rolltype='1d100!>@{oeuproll}cf<2cs=100';
                            attributes.npcattack5attackcalc='@{npcattack5bonus}Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                        } else if(npcinputfile.attack5type=='Area Spell'){
                            attributes.npcattack5select='npcarea';
                            attributes.npcattack5type='[[@{npcattack5rolltype} +@{npcattack5attackcalc}]]';
                            attributes.npcattack5rolltype='1d100cf<4cs>96';
                            attributes.npcattack5attackcalc='@{npcattack5bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]';
                        } else {
                            attributes.npcattack5select='none';
                        }
                    }
                    if(npcinputfile.attack6name!=null)					
                        attributes.npcattack6name=npcinputfile.attack6name;
                    if(npcinputfile.attack6ob!=null)
                        attributes.npcattack6bonus=npcinputfile.attack6ob;
                    if(npcinputfile.attack6perc!=null)					
                        attributes.npcattack6percent=npcinputfile.attack6perc;
                    if(npcinputfile.attack6type!=null){
                        if(npcinputfile.attack6type=='Melee'){
                            attributes.npcattack6select='npcmelee';
                            attributes.npcattack6type='[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
                            attributes.npcattack6rolltype='1d100!>@{oeuproll}cf<@{npcattack6fumble}';
                            attributes.npcattack6attackcalc='@{npcattack6bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]';
                        } else if(npcinputfile.attack6type=='Ranged'){
                            attributes.npcattack6select='npcranged';
                            attributes.npcattack6type='[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
                            attributes.npcattack6rolltype='1d100!>@{oeuproll}cf<@{npcattack6fumble}';
                            attributes.npcattack6attackcalc='@{npcattack6bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action]';
                        } else if(npcinputfile.attack6type=='Basic Spell'){
                            attributes.npcattack6select='npcbasic';
                            attributes.npcattack6type='[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
                            attributes.npcattack6rolltype='1d100cf<2cs>96';
                            attributes.npcattack6attackcalc='@{npcattack6bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}';
                        } else if(npcinputfile.attack6type=='Directed Spell'){
                            attributes.npcattack6select='npcdirected';
                            attributes.npcattack6type='[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
                            attributes.npcattack6rolltype='1d100!>@{oeuproll}cf<2cs=100';
                            attributes.npcattack6attackcalc='@{npcattack6bonus}Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                        } else if(npcinputfile.attack6type=='Area Spell'){
                            attributes.npcattack6select='npcarea';
                            attributes.npcattack6type='[[@{npcattack6rolltype} +@{npcattack6attackcalc}]]';
                            attributes.npcattack6rolltype='1d100cf<4cs>96';
                            attributes.npcattack6attackcalc='@{npcattack6bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]';
                        } else {
                            attributes.npcattack6select='none';
                        }
                    }
                    if(npcinputfile.attack7name!=null)					
                        attributes.npcattack7name=npcinputfile.attack7name;
                    if(npcinputfile.attack7ob!=null)
                        attributes.npcattack7bonus=npcinputfile.attack7ob;
                    if(npcinputfile.attack7perc!=null)					
                        attributes.npcattack7percent=npcinputfile.attack7perc;
                    if(npcinputfile.attack7type!=null){
                        if(npcinputfile.attack7type=='Melee'){
                            attributes.npcattack7select='npcmelee';
                            attributes.npcattack7type='[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
                            attributes.npcattack7rolltype='1d100!>@{oeuproll}cf<@{npcattack7fumble}';
                            attributes.npcattack7attackcalc='@{npcattack7bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]';
                        } else if(npcinputfile.attack7type=='Ranged'){
                            attributes.npcattack7select='npcranged';
                            attributes.npcattack7type='[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
                            attributes.npcattack7rolltype='1d100!>@{oeuproll}cf<@{npcattack7fumble}';
                            attributes.npcattack7attackcalc='@{npcattack7bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action]';
                        } else if(npcinputfile.attack7type=='Basic Spell'){
                            attributes.npcattack7select='npcbasic';
                            attributes.npcattack7type='[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
                            attributes.npcattack7rolltype='1d100cf<2cs>96';
                            attributes.npcattack7attackcalc='@{npcattack7bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}';
                        } else if(npcinputfile.attack7type=='Directed Spell'){
                            attributes.npcattack7select='npcdirected';
                            attributes.npcattack7type='[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
                            attributes.npcattack7rolltype='1d100!>@{oeuproll}cf<2cs=100';
                            attributes.npcattack7attackcalc='@{npcattack7bonus}Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                        } else if(npcinputfile.attack7type=='Area Spell'){
                            attributes.npcattack7select='npcarea';
                            attributes.npcattack7type='[[@{npcattack7rolltype} +@{npcattack7attackcalc}]]';
                            attributes.npcattack7rolltype='1d100cf<4cs>96';
                            attributes.npcattack7attackcalc='@{npcattack7bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]';
                        } else {
                            attributes.npcattack7select='none';
                        }
                    }
                    if(npcinputfile.attack8name!=null)					
                        attributes.npcattack8name=npcinputfile.attack8name;
                    if(npcinputfile.attack8ob!=null)
                        attributes.npcattack8bonus=npcinputfile.attack8ob;
                    if(npcinputfile.attack8perc!=null)					
                        attributes.npcattack8percent=npcinputfile.attack8perc;
                    if(npcinputfile.attack8type!=null){
                        if(npcinputfile.attack8type=='Melee'){
                            attributes.npcattack8select='npcmelee';
                            attributes.npcattack8type='[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
                            attributes.npcattack8rolltype='1d100!>@{oeuproll}cf<@{npcattack8fumble}';
                            attributes.npcattack8attackcalc='@{npcattack8bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]-(100-?{% Activity used on attack|100})[% Action]';
                        } else if(npcinputfile.attack8type=='Ranged'){
                            attributes.npcattack8select='npcranged';
                            attributes.npcattack8type='[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
                            attributes.npcattack8rolltype='1d100!>@{oeuproll}cf<@{npcattack8fumble}';
                            attributes.npcattack8attackcalc='@{npcattack8bonus}[Att Bonus]+?{Position Bonus?|0}[Position]+?{Status Bonus/Penalty?|0}[Status]+?{Parry(db adjust: should be negative)|0}[Parry]+?{Range Modification|0}[Range]-@{dbmisspenworn}[Missile Penalty for arm covering]-(60-?{% Activity used on attack|60})[% Action]';
                        } else if(npcinputfile.attack8type=='Basic Spell'){
                            attributes.npcattack8select='npcbasic';
                            attributes.npcattack8type='[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
                            attributes.npcattack8rolltype='1d100cf<2cs>96';
                            attributes.npcattack8attackcalc='@{npcattack8bonus}[List Ranks]+?{Special Item Bonus?|0}+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}';
                        } else if(npcinputfile.attack8type=='Directed Spell'){
                            attributes.npcattack8select='npcdirected';
                            attributes.npcattack8type='[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
                            attributes.npcattack8rolltype='1d100!>@{oeuproll}cf<2cs=100';
                            attributes.npcattack8attackcalc='@{npcattack8bonus}Att Bonus]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]';
                        } else if(npcinputfile.attack8type=='Area Spell'){
                            attributes.npcattack8select='npcarea';
                            attributes.npcattack8type='[[@{npcattack8rolltype} +@{npcattack8attackcalc}]]';
                            attributes.npcattack8rolltype='1d100cf<4cs>96';
                            attributes.npcattack8attackcalc='@{npcattack8bonus}[List Ranks]+?{Special Item Bonus?|0}[Special Item]+?{Status Bonus/Penalty?|0}[Status]+?{Range Modification|0}[Range]+20*?{Center point of spell?(1=yes)|0}[Spell Center]';
                        } else {
                            attributes.npcattack8select='none';
                        }
                    }
                      
                    if(npcinputfile.creature!=null){
                        attributes.npcname=npcinputfile.creature;
                        attributes.character_name=npcinputfile.creature;	
                    }
                  
                    attributes.npcimportcheckbox='0';
                    attributes.npcinput='';
                }catch(err){
                    goodcode=false;
                    error='Error with Character Info';
                }
                try{
                    setAttrs(attributes);
                }catch(err){
                    setAttrs({
                        npcinput:'Error setting Attributes',
                        npcimportcheckbox:'0',
                        warningcheckbox:'0'
                    });
                }
            }else{
                setAttrs({
                    npcinput:'Error: invalid Structure',
                    npcimportcheckbox:'0'  //,  <-- last item should not have a comma
                    //                   warningcheckbox:"0"
                });
            }
        }
    });
});


</script>
<!-- end Sheet Workers Section-->